!function(e,t){"use strict";class a{static cullByCameraCullInfo(e,a,r,s,i,n){const o=e.boundFrustum,h=e.cullingMask,d=e.staticMask;let l,c;for(let _=0;_<r;_++)if(l=a[_],c=!!(1<<l.layer&h)&&0==l.renderbitFlag,c=c&&0!=(l.staticMask&d),c&&(!e.useOcclusionCulling||l._needRender(o))){let a;l.distanceForSort=t.Vector3.distanceSquared(l.bounds._imp.getCenter(),e.position),l._renderUpdatePre(n);const r=l.renderelements;for(let e=0,t=r.length;e<t;e++)a=r[e],a.materialRenderQueue>2500?i.addRenderElement(a):s.addRenderElement(a)}}static cullDirectLightShadow(e,a,r,s,i){s.clear();for(let n=0;n<r;n++){const r=a[n];if(r.shadowCullPass()&&t.FrustumCulling.cullingRenderBounds(r.bounds,e)){let a;r.distanceForSort=t.Vector3.distanceSquared(r.bounds._imp.getCenter(),e.position),r._renderUpdatePre(i);const n=r.renderelements;for(let e=0,t=n.length;e<t;e++)a=n[e],a.materialRenderQueue<2500&&s.addRenderElement(a)}}}static cullSpotShadow(e,a,r,s,i){s.clear();const n=e.boundFrustum;for(let o=0;o<r;o++){const r=a[o];if(r._renderUpdatePre(i),r.shadowCullPass()&&(r.distanceForSort=t.Vector3.distanceSquared(r.bounds._imp.getCenter(),e.position),r._needRender(n))){let e;const t=r.renderelements;for(let a=0,r=t.length;a<r;a++)e=t[a],e.materialRenderQueue<2500&&s.addRenderElement(e)}}}}class r{static renderCmd(e,t){e&&e.length>0&&e.forEach(e=>t.runCMDList(e._renderCMDs))}static recoverRenderContext3D(e,a){e.setViewPort(this.contextViewPortCache),e.setScissor(this.contextScissorCache),e.setRenderTarget(a,t.RenderClearFlag.Nothing)}}r.contextViewPortCache=new t.Viewport,r.contextScissorCache=new t.Vector4;class s{sort(e,t,a,r){this.elementArray=e,this.isTransparent=t,this._quickSort(a,r)}_quickSort(e,t){if(this.elementArray.length>1){const a=this._partitionRenderObject(e,t),r=a-1;e<r&&this._quickSort(e,r),a<t&&this._quickSort(a,t)}}_partitionRenderObject(e,t){const a=this.elementArray.elements,r=a[Math.floor((t+e)/2)];for(;e<=t;){for(;this._compare(a[e],r)<0;)e++;for(;this._compare(a[t],r)>0;)t--;if(e<t){const r=a[e];a[e]=a[t],a[t]=r,e++,t--}else if(e===t){e++;break}}return e}_compare(e,t){const a=e.materialRenderQueue-t.materialRenderQueue;if(0===a){return(this.isTransparent?t.owner.distanceForSort-e.owner.distanceForSort:e.owner.distanceForSort-t.owner.distanceForSort)+t.owner.sortingFudge-e.owner.sortingFudge}return a}}class i{get elements(){return this._elements}constructor(e){this._elements=new t.FastSinglelist,this._isTransparent=e,this._quickSort=new s,this._batch=t.Laya3DRender.Render3DPassFactory.createInstanceBatch()}addRenderElement(e){e.materialShaderData&&this._elements.add(e)}_batchQueue(){if(!this._isTransparent){let e=performance.now();this._batch.batch(this._elements),t.LayaGL.statAgent.recordTimeData(t.StatElement.T_3DBatchTime,performance.now()-e)}}renderQueue(e){this._batchQueue();const a=this._elements.length;this._quickSort.sort(this._elements,this._isTransparent,0,a-1),e.drawRenderElementList(this._elements),t.LayaGL.statAgent.recordCTData(this._isTransparent?t.StatElement.CT_TransDrawCall:t.StatElement.CT_OpaqueDrawCall,this.elements.length),this._batch.clearRenderData()}clear(){this._elements.elements.fill(null),this._elements.length=0}destroy(){this.clear(),this._elements=null}}class n{get shaderData(){return this._shaderData}set shaderData(e){this._shaderData=e}_renderUpdatePre(e){this._updateMark!=e.cameraUpdateMask&&(this._renderUpdatePreFun.call(this._renderUpdatePreCall,e),this._updateMark=e.cameraUpdateMask)}_calculateBoundingBox(){this._caculateBoundingBoxFun.call(this._caculateBoundingBoxCall)}get bounds(){return this.boundsChange&&(this._calculateBoundingBox(),this.boundsChange=!1),this._bounds}set bounds(e){this._bounds=e}get additionShaderData(){return this._additionShaderData}set additionShaderData(e){this._additionShaderData=e,this._additionShaderDataKeys=e?Array.from(this._additionShaderData.keys()):[]}constructor(){this.ismoved=new t.Vector2,this.renderelements=[],this._commonUniformMap=[],this._worldParams=new t.Vector4(1,0,0,0),this.lightmapDirtyFlag=-1,this.lightmapScaleOffset=new t.Vector4(1,1,0,0),this.set_caculateBoundingBox(this,this._ownerCalculateBoundingBox),this._additionShaderData=new Map}setNodeCustomData(e,t){switch(e){case 0:this._worldParams.y=t;break;case 1:this._worldParams.z=t;break;case 2:this._worldParams.w=t}}set_renderUpdatePreCall(e,t){this._renderUpdatePreCall=e,this._renderUpdatePreFun=t}set_caculateBoundingBox(e,t){this._caculateBoundingBoxCall=e,this._caculateBoundingBoxFun=t}_needRender(e){return!e||e.intersects(this.bounds)}setRenderelements(e){this.renderelements.length=0;for(var t=0;t<e.length;t++)this.renderelements.push(e[t]),e[t].owner=this}setOneMaterial(e,t){this.renderelements[e]&&(this.renderelements[e].materialShaderData=t.shaderData,this.renderelements[e].materialRenderQueue=t.renderQueue,this.renderelements[e].subShader=t.shader.getSubShaderAt(0),this.renderelements[e].materialId=t._id)}setLightmapScaleOffset(e){e&&e.cloneTo(this.lightmapScaleOffset)}setCommonUniformMap(e){this._commonUniformMap.length=0,e.forEach(e=>{this._commonUniformMap.push(e)})}shadowCullPass(){return this.castShadow&&this.enable&&0==this.renderbitFlag}_ownerCalculateBoundingBox(){this.baseGeometryBounds._tranform(this.transform.worldMatrix,this._bounds)}_applyLightMapParams(){let e=this.shaderData;if(this.lightmap){let a=this.lightmap;e.setVector(t.RenderableSprite3D.LIGHTMAPSCALEOFFSET,this.lightmapScaleOffset),e._setInternalTexture(t.RenderableSprite3D.LIGHTMAP,a.lightmapColor),e.addDefine(t.RenderableSprite3D.SAHDERDEFINE_LIGHTMAP),a.lightmapDirection?(e._setInternalTexture(t.RenderableSprite3D.LIGHTMAP_DIRECTION,a.lightmapDirection),e.addDefine(t.RenderableSprite3D.SHADERDEFINE_LIGHTMAP_DIRECTIONAL)):e.removeDefine(t.RenderableSprite3D.SHADERDEFINE_LIGHTMAP_DIRECTIONAL)}else e.removeDefine(t.RenderableSprite3D.SAHDERDEFINE_LIGHTMAP),e.removeDefine(t.RenderableSprite3D.SHADERDEFINE_LIGHTMAP_DIRECTIONAL)}_applyLightProb(){this.lightmapIndex>=0||!this.volumetricGI||this.volumetricGI.updateMark!=this.lightProbUpdateMark&&(this.lightProbUpdateMark=this.volumetricGI.updateMark,this.volumetricGI.applyRenderData())}_applyReflection(){this.probeReflection&&this.reflectionMode!=t.ReflectionProbeMode.off&&this.probeReflection.needUpdate()&&this.probeReflection.applyRenderData()}destroy(){this.renderelements.forEach(e=>{e.destroy()}),this.baseGeometryBounds=null,this.transform=null,this.lightmapScaleOffset=null,this.lightmap=null,this.probeReflection=null,this.volumetricGI=null,this.renderelements.length=0,this.renderelements=null,this.shaderData&&this.shaderData.destroy(),this.shaderData=null,this._commonUniformMap.length=0,this._commonUniformMap=null,this.additionShaderData.clear(),this.additionShaderData=null,this._additionShaderDataKeys.length=0,this._additionShaderDataKeys=null}}class o{constructor(){this._shadowFourCascadeSplits=new t.Vector3,this._direction=new t.Vector3}setShadowFourCascadeSplits(e){e&&e.cloneTo(this._shadowFourCascadeSplits)}setDirection(e){e&&e.cloneTo(this._direction)}}class h{destroy(){this.lightmapColor=null,this.lightmapDirection=null}}var d=null;function l(){return d||(d=class extends n.BaseRenderNodeClass{constructor(){super(),this._cacheMoved=new t.Vector2(-1,-1),this.set_renderUpdatePreCall(this,this._renderUpdate)}_renderUpdate(e){if(e.sceneModuleData.lightmapDirtyFlag!=this.lightmapDirtyFlag&&(this._applyLightMapParams(),this.lightmapDirtyFlag=e.sceneModuleData.lightmapDirtyFlag),this._applyReflection(),this._applyLightProb(),this.ismoved.x>this._cacheMoved.x||this.ismoved.x==this._cacheMoved.x&&this.ismoved.y>this._cacheMoved.y){let e=this.transform;this.shaderData.setMatrix4x4(t.Sprite3D.WORLDMATRIX,e.worldMatrix),this._worldParams.x=e.getFrontFaceValue(),this.shaderData.setVector(t.Sprite3D.WORLDINVERTFRONT,this._worldParams),this.ismoved.cloneTo(this._cacheMoved)}}}),d}class c{constructor(){this._projectViewMatrix=new t.Matrix4x4}setProjectionViewMatrix(e){e&&e.cloneTo(this._projectViewMatrix)}}class _{}class u{}class p{constructor(){this._id=++p._idCounter,this._updateMaskFlag=-1,this._shCoefficients=[],this._probePosition=new t.Vector3,this._ambientColor=new t.Color,this.shaderData=t.LayaGL.renderDeviceFactory.createShaderData()}needUpdate(){return this.updateMark!=this._updateMaskFlag}destroy(){this.bound=null,delete this._shCoefficients,delete this._ambientSH,this.shaderData.destroy(),this.shaderData=null}setAmbientSH(e){this._ambientSH=e}setShCoefficients(e){this._shCoefficients.length=0,e.forEach(e=>{var a=new t.Vector4;e.cloneTo(a),this._shCoefficients.push(a)})}setProbePosition(e){e&&e.cloneTo(this._probePosition)}setreflectionHDRParams(e){e&&e.cloneTo(this._reflectionHDRParams)}setAmbientColor(e){e&&e.cloneTo(this._ambientColor)}applyRenderData(){this._updateMaskFlag=this.updateMark;let e=this.shaderData;this.boxProjection?(e.addDefine(t.Sprite3DRenderDeclaration.SHADERDEFINE_SPECCUBE_BOX_PROJECTION),e.setVector3(t.ReflectionProbe.REFLECTIONCUBE_PROBEPOSITION,this._probePosition),e.setVector3(t.ReflectionProbe.REFLECTIONCUBE_PROBEBOXMAX,this.bound.getMax()),e.setVector3(t.ReflectionProbe.REFLECTIONCUBE_PROBEBOXMIN,this.bound.getMin())):e.removeDefine(t.Sprite3DRenderDeclaration.SHADERDEFINE_SPECCUBE_BOX_PROJECTION),this.ambientMode==t.AmbientMode.SolidColor?(e.removeDefine(t.Sprite3DRenderDeclaration.SHADERDEFINE_GI_LEGACYIBL),e.removeDefine(t.ReflectionProbe.SHADERDEFINE_GI_IBL),e.setColor(t.ReflectionProbe.AMBIENTCOLOR,this._ambientColor)):this.iblTex&&this._ambientSH?(e.addDefine(t.ReflectionProbe.SHADERDEFINE_GI_IBL),e.removeDefine(t.Sprite3DRenderDeclaration.SHADERDEFINE_GI_LEGACYIBL),this.iblTex&&(e._setInternalTexture(t.ReflectionProbe.IBLTEX,this.iblTex),e.setNumber(t.ReflectionProbe.IBLROUGHNESSLEVEL,this.iblTex.maxMipmapLevel)),this.iblTexRGBD?e.addDefine(t.Sprite3DRenderDeclaration.SHADERDEFINE_IBL_RGBD):e.removeDefine(t.Sprite3DRenderDeclaration.SHADERDEFINE_IBL_RGBD),this._ambientSH&&e.setBuffer(t.ReflectionProbe.AMBIENTSH,this._ambientSH)):(e.removeDefine(t.Sprite3DRenderDeclaration.SHADERDEFINE_GI_LEGACYIBL),e.removeDefine(t.ReflectionProbe.SHADERDEFINE_GI_IBL)),e.setNumber(t.ReflectionProbe.AMBIENTINTENSITY,this.ambientIntensity),e.setNumber(t.ReflectionProbe.REFLECTIONINTENSITY,this.reflectionIntensity)}}p._idCounter=0;var D=null;function m(){return D||(D=class extends n.BaseRenderNodeClass{constructor(){super(),this._bones=[],this.set_renderUpdatePreCall(this,this._renderUpdate)}setRootBoneTransfom(e){this._cacheRootBone=e.transform}setOwnerTransform(e){this._owner=e.transform}setCacheMesh(e){this._cacheMesh=e,this._skinnedDataLoopMarks=new Uint32Array(e._inverseBindPoses.length)}setBones(e){this._bones=e}setSkinnedData(e){this._skinnedData=e}computeSkinnedData(){for(var e=this._cacheMesh._inverseBindPoses,t=this._cacheMesh._skinnedMatrixCaches,a=0,r=this._cacheMesh.subMeshCount;a<r;a++)for(var s=this._cacheMesh.getSubMesh(a)._boneIndicesList,i=this._skinnedData[a],n=0,o=s.length;n<o;n++){var h=s[n];this._computeSubSkinnedData(e,h,i[n],t)}}_computeSubSkinnedData(e,a,r,s){for(let i=0,n=a.length;i<n;i++){let n=a[i];if(this._skinnedDataLoopMarks[n]===t.Stat.loopCount){let e=s[n],t=this._skinnedData[e.subMeshIndex][e.batchIndex],a=16*e.batchBoneIndex,o=16*i;for(let e=0;e<16;e++)r[o+e]=t[a+e]}else{let a=this._bones[n];a&&t.Utils3D._mulMatrixArray(a.transform.worldMatrix.elements,e[n].elements,0,r,16*i),this._skinnedDataLoopMarks[n]=t.Stat.loopCount}}}_renderUpdate(e){let a=this._owner.worldMatrix,r=this._worldParams;r.x=this._owner.getFrontFaceValue(),this._cacheRootBone&&(a=t.Matrix4x4.DEFAULT,r.x=1),this._applyLightProb(),this._applyReflection(),this.shaderData.setMatrix4x4(t.Sprite3D.WORLDMATRIX,a),this.shaderData.setVector(t.Sprite3D.WORLDINVERTFRONT,r)}}),D}class S{setDirection(e){e.cloneTo(this._direction)}getWorldMatrix(e){var a=this.transform.position,r=this.transform.rotation;return t.Matrix4x4.createAffineTransformation(a,r,t.Vector3.ONE,e),e}}class f{constructor(){this._id=++f._idCounter,this._probeCounts=new t.Vector3,this._probeStep=new t.Vector3,this._params=new t.Vector4,this._params=new t.Vector4,this.bound=new t.Bounds,this.shaderData=t.LayaGL.renderDeviceFactory.createShaderData()}setParams(e){e.cloneTo(this._params)}setProbeCounts(e){e.cloneTo(this._probeCounts)}setProbeStep(e){e.cloneTo(this._probeStep)}applyRenderData(){let e=this.shaderData;e.addDefine(t.VolumetricGI.SHADERDEFINE_VOLUMETRICGI),e.setVector3(t.VolumetricGI.VOLUMETRICGI_PROBECOUNTS,this._probeCounts),e.setVector3(t.VolumetricGI.VOLUMETRICGI_PROBESTEPS,this._probeStep),e.setVector3(t.VolumetricGI.VOLUMETRICGI_PROBESTARTPOS,this.bound.getMin()),e.setVector(t.VolumetricGI.VOLUMETRICGI_PROBEPARAMS,this._params),e._setInternalTexture(t.VolumetricGI.VOLUMETRICGI_IRRADIANCE,this.irradiance),e._setInternalTexture(t.VolumetricGI.VOLUMETRICGI_DISTANCE,this.distance),e.setNumber(t.ReflectionProbe.AMBIENTINTENSITY,this.intensity)}destroy(){this.shaderData.destroy(),this.shaderData=null,this.irradiance=null,this.distance=null,this.bound=null}}f._idCounter=0;var w=null;function g(){return w||(w=class extends n.BaseRenderNodeClass{constructor(){super(),this.set_renderUpdatePreCall(this,this._renderUpdate),this._simpleAnimatorParams=new t.Vector4}setSimpleAnimatorParams(e){e.cloneTo(this._simpleAnimatorParams),this.shaderData.setVector(t.SimpleSkinnedMeshSprite3D.SIMPLE_SIMPLEANIMATORPARAMS,this._simpleAnimatorParams)}_renderUpdate(e){let a=this.shaderData,r=this.transform.worldMatrix,s=this._worldParams;s.x=this.transform.getFrontFaceValue(),a.setMatrix4x4(t.Sprite3D.WORLDMATRIX,r),a.setVector(t.Sprite3D.WORLDINVERTFRONT,s),this._applyLightProb(),this._applyReflection(),a.setVector(t.SimpleSkinnedMeshSprite3D.SIMPLE_SIMPLEANIMATORPARAMS,this._simpleAnimatorParams)}}),w}class C{createSimpleSkinRenderNode(){return new(g())}createTransform(e){return new t.Transform3D(e)}createBounds(e,a){return new t.BoundsImpl(e,a)}createVolumetricGI(){return new f}createReflectionProbe(){return new p}createLightmapData(){return new h}createDirectLight(){return new o}createSpotLight(){return new S}createPointLight(){return new u}createCameraModuleData(){return new c}createSceneModuleData(){return new _}createBaseRenderNode(){return new n}createMeshRenderNode(){return new(l())}createSkinRenderNode(){return new(m())}}t.Laya.addBeforeInitCallback(()=>{t.Laya3DRender.Render3DModuleDataFactory||(t.Laya3DRender.Render3DModuleDataFactory=new C)});class M{constructor(){this._list=new t.SingletonList,this.baseRenderList=new t.SingletonList}get list(){return this._list}set list(e){this._list=e;let t=this._list.elements;this.baseRenderList.clear();for(let e=0;e<this._list.length;e++)this.baseRenderList.add(t[e]._baseRenderNode)}addRenderObject(e){this._list.add(e),this.baseRenderList.add(e._baseRenderNode)}removeRenderObject(e){this._list.remove(e),this.baseRenderList.remove(e._baseRenderNode)}removeMotionObject(e){}updateMotionObjects(){}addMotionObject(e){}destroy(){this._list.destroy(),this.baseRenderList.destroy(),this._list=null,this.baseRenderList=null}}class R{constructor(){this._batchOpaqueMarks=[],this._updateCountMark=0,this.recoverList=new t.FastSinglelist}getBatchMark(e){const a=e.owner,r=e.geometry,s=!!e.transform&&e.transform._isFrontFaceInvert?1:0,i=a.receiveShadow?1:0,n=r._id,o=(e.materialId<<17)+(n<<2)+(s<<1)+i,h=((a.probeReflection?a.probeReflection._id:-1)+1<<10)+(a.lightmapIndex+1<<20)+((a.volumetricGI?a.volumetricGI._id:-1)+1),d=this._batchOpaqueMarks[o]||(this._batchOpaqueMarks[o]={});return d[h]||(d[h]=new t.BatchMark)}batch(e){if(!t.Config3D.enableDynamicBatch||!t.LayaGL.renderEngine.getCapable(t.RenderCapable.DrawElement_Instance))return;const a=e.length,r=e.elements,s=R.MaxInstanceCount;e.length=0,this._updateCountMark++;for(let i=0;i<a;i++){const a=r[i];if(a.canDynamicBatch&&a.subShader._owner._enableInstancing){const i=this.getBatchMark(a);if(this._updateCountMark==i.updateMark){const n=i.indexInList;if(i.batched){const t=r[n].instanceElementList;t.length===s?(i.indexInList=e.length,i.batched=!1,e.add(a)):t.add(a)}else{const e=r[n],s=t.Laya3DRender.Render3DPassFactory.createInstanceRenderElement3D();this.recoverList.add(s),s.subShader=a.subShader,s.materialShaderData=a.materialShaderData,s.materialRenderQueue=a.materialRenderQueue,s.renderShaderData=a.renderShaderData,s.owner=a.owner,s.setGeometry(a.geometry);const o=s.instanceElementList;o.length=0,o.add(e),o.add(a),r[n]=s,i.batched=!0}}else i.updateMark=this._updateCountMark,i.indexInList=e.length,i.batched=!1,e.add(a)}else e.add(a)}}clearRenderData(){for(let e=this.recoverList.length-1;e>-1;e--){this.recoverList.elements[e].clearRenderData()}}recoverData(){for(let e=this.recoverList.length-1;e>-1;e--){this.recoverList.elements[e].recover()}this.recoverList.length=0}}R.MaxInstanceCount=1024;class P{constructor(){this._shaderInstances=new t.FastSinglelist}_addShaderInstance(e){this._shaderInstances.add(e)}_clearShaderInstance(){this._shaderInstances.length=0}_preUpdatePre(e){if(this._compileShader(e),this.materialShaderData&&t.Config.matUseUBO){let e=this.subShader,t=this.materialShaderData.createSubUniformBuffer("Material",e._owner.name,e._uniformMap);t&&t.upload()}if(this.owner&&t.Config._uniformBlock)for(let[e,a]of this.owner.additionShaderData){let r=a,s=t.LayaGL.renderDeviceFactory.createGlobalUniformMap(e),i=r.createSubUniformBuffer(e,e,s._idata);i&&i.upload()}this._invertFront=this._getInvertFront()}_getInvertFront(){var e;let t=null===(e=this.owner)||void 0===e?void 0:e.transform;return!!t&&t._isFrontFaceInvert}_render(e){let t=e.invertY,a=e.cameraUpdateMask,r=e.sceneData,s=e.cameraData;if(this.isRender){let e=this._shaderInstances.elements;for(let i=0,n=this._shaderInstances.length;i<n;i++){const n=e[i];if(!n.complete)continue;let o=n.bind(),h=a!==n._uploadMark,d=n._uploadScene!==r||h;if((d||o)&&(r&&n.uploadUniforms(n._sceneUniformParamsMap,r,d),n._uploadScene=r),this.renderShaderData){let e=n._uploadRender!==this.renderShaderData||h;(e||o)&&(n.uploadUniforms(n._spriteUniformParamsMap,this.renderShaderData,e),n._uploadRender=this.renderShaderData)}if(this.owner){let e=this.owner.additionShaderData;for(let[t,a]of n._additionUniformParamsMaps){let r=e.get(t);if(r){let e=n._additionShaderData.get(t)!==r||h;(e||o)&&(n.uploadUniforms(a,r,e),n._additionShaderData.set(t,r))}}}let l=n._uploadCameraShaderValue!==s||h;(l||o)&&(s&&n.uploadUniforms(n._cameraUniformParamsMap,s,l),n._uploadCameraShaderValue=s);let c=n._uploadMaterial!==this.materialShaderData||h;(c||o)&&(n.uploadUniforms(n._materialUniformParamsMap,this.materialShaderData,c),n._uploadMaterial=this.materialShaderData),n.uploadRenderStateBlendDepth(this.materialShaderData),n.uploadRenderStateFrontFace(this.materialShaderData,t,this._invertFront),this.drawGeometry(n)}}}_getShaderInstanceDefines(e){let t=P._compileDefine;if(e._getContextShaderDefines().cloneTo(t),this.renderShaderData&&t.addDefineDatas(this.renderShaderData.getDefineData()),this.materialShaderData&&t.addDefineDatas(this.materialShaderData._defineDatas),this.owner){let e=this.owner.additionShaderData;if(e.size>0)for(let[a,r]of e.entries())t.addDefineDatas(r.getDefineData())}return t}_compileShader(e){this._clearShaderInstance();for(var t=this.subShader._passes,a=0,r=t.length;a<r;a++){let r=t[a],i=r.moduleData;if(i.pipelineMode!==e.pipelineMode)continue;this.renderShaderData?i.nodeCommonMap=this.owner._commonUniformMap:i.nodeCommonMap=null,i.additionShaderData=null,this.owner&&(i.additionShaderData=this.owner._additionShaderDataKeys);let n=this._getShaderInstanceDefines(e);var s=r.withCompile(n);this._addShaderInstance(s)}}drawGeometry(e){t.WebGLEngine.instance.getDrawContext().drawGeometryElement(this.geometry)}destroy(){this.geometry=null,this._shaderInstances=null,this.materialShaderData=null,this.renderShaderData=null,this.transform=null,this.isRender=null}}P._compileDefine=new t.WebDefineDatas;class T extends P{static getInstanceBufferState(e,a,r){let s=T._instanceBufferStateMap.get(e._id);if(!s){s={state:new t.WebGLBufferState};let i=e.bufferState._vertexBuffers.slice(),n=new t.WebGLVertexBuffer(t.BufferTargetType.ARRAY_BUFFER,t.BufferUsage.Dynamic);switch(n.setDataLength(20*T.MaxInstanceCount*4),n.vertexDeclaration=t.VertexMesh.instanceWorldMatrixDeclaration,n.instanceBuffer=!0,i.push(n),s.worldInstanceVB=n,a){case t.BaseRenderType.MeshRender:if(r.has(t.MeshSprite3DShaderDeclaration.SHADERDEFINE_UV1)){let e=new t.WebGLVertexBuffer(t.BufferTargetType.ARRAY_BUFFER,t.BufferUsage.Dynamic);e.setDataLength(4*T.MaxInstanceCount*4),e.vertexDeclaration=t.VertexMesh.instanceLightMapScaleOffsetDeclaration,e.instanceBuffer=!0,i.push(e),s.lightmapScaleOffsetVB=e}break;case t.BaseRenderType.SimpleSkinRender:let e=new t.WebGLVertexBuffer(t.BufferTargetType.ARRAY_BUFFER,t.BufferUsage.Dynamic);e.setDataLength(4*T.MaxInstanceCount*4),e.vertexDeclaration=t.VertexMesh.instanceSimpleAnimatorDeclaration,e.instanceBuffer=!0,i.push(e),s.simpleAnimatorVB=e}s.state.applyState(i,e.bufferState._bindedIndexBuffer),T._instanceBufferStateMap.set(e._id,s)}return s}static create(){return this._pool.pop()||new T}static _instanceBufferCreate(e){let t=T._bufferPool.get(e);return t||(T._bufferPool.set(e,[]),t=T._bufferPool.get(e)),t.pop()||new Float32Array(e)}constructor(){super(),this._vertexBuffers=[],this._updateData=[],this._updateDataNum=[],this.instanceElementList=new t.FastSinglelist,this.drawCount=0,this.updateNums=0,this.isRender=!0}addUpdateData(e,t,a){this._vertexBuffers[this.updateNums]=e,this._updateDataNum[this.updateNums]=t;let r=this._updateData[this.updateNums]=T._instanceBufferCreate(t*a);return this.updateNums++,r}_compileShader(e){this._clearShaderInstance();let a=this.subShader._passes;for(let r=0;r<a.length;r++){let s=a[r];if(s.pipelineMode!=e.pipelineMode)continue;this.renderShaderData?s.nodeCommonMap=this.owner._commonUniformMap:s.nodeCommonMap=null,s.additionShaderData=null,this.owner&&(s.additionShaderData=this.owner._additionShaderDataKeys);let i=this._getShaderInstanceDefines(e);i.add(t.MeshSprite3DShaderDeclaration.SHADERDEFINE_GPU_INSTANCE);let n=s.withCompile(i);this._addShaderInstance(n)}this._shaderInstances.length>0&&this._updateInstanceData()}_updateInstanceData(){switch(this.owner.renderNodeType){case t.BaseRenderType.MeshRender:{let n=this.addUpdateData(this._instanceStateInfo.worldInstanceVB,20,T.MaxInstanceCount);var e=(s=this.instanceElementList).elements,a=s.length;this.drawCount=a,this.geometry.instanceCount=this.drawCount;for(var r=0;r<a;r++)n.set(e[r].transform.worldMatrix.elements,20*r),e[r].owner._worldParams.writeTo(n,20*r+16);if(this.renderShaderData.hasDefine(t.RenderableSprite3D.SAHDERDEFINE_LIGHTMAP)&&this.renderShaderData.hasDefine(t.MeshSprite3DShaderDeclaration.SHADERDEFINE_UV1)){let t=this.addUpdateData(this._instanceStateInfo.lightmapScaleOffsetVB,4,T.MaxInstanceCount);for(r=0;r<a;r++){let a=e[r].owner.lightmapScaleOffset;t[i=4*r]=a.x,t[i+1]=a.y,t[i+2]=a.z,t[i+3]=a.w}}break}case t.BaseRenderType.SimpleSkinRender:{let o=this.addUpdateData(this._instanceStateInfo.worldInstanceVB,20,T.MaxInstanceCount);var s;e=(s=this.instanceElementList).elements,a=s.length;this.drawCount=a,this.geometry.instanceCount=this.drawCount;for(r=0;r<a;r++)o.set(e[r].transform.worldMatrix.elements,20*r),e[r].owner._worldParams.writeTo(o,20*r+16);let h=this.addUpdateData(this._instanceStateInfo.simpleAnimatorVB,4,T.MaxInstanceCount);for(r=0;r<a;r++){var i,n=e[r].renderShaderData.getVector(t.SimpleSkinnedMeshSprite3D.SIMPLE_SIMPLEANIMATORPARAMS);h[i=4*r]=n.x,h[i+1]=n.y,h[i+2]=n.z,h[i+3]=n.w}break}}}setGeometry(e){this.geometry||(this.geometry=new t.WebGLRenderGeometryElement(e.mode,e.drawType)),e.cloneTo(this.geometry),this.geometry.drawType=t.DrawType.DrawElementInstance,this._instanceStateInfo=T.getInstanceBufferState(e,this.owner.renderNodeType,this.renderShaderData._defineDatas),this.geometry.bufferState=this._instanceStateInfo.state}_render(e){for(let e=0;e<this.updateNums;e++){let t=this._vertexBuffers[e];if(!t)break;let a=this._updateData[e];t.orphanStorage(),t.setData(a.buffer,0,0,this.drawCount*this._updateDataNum[e]*4)}super._render(e),this.clearRenderData()}clearRenderData(){this.drawCount=0,this.updateNums=0,this._vertexBuffers.length=0,this._updateData.forEach(e=>{T._bufferPool.get(e.length).push(e)}),this._updateData.length=0,this._updateDataNum.length=0}recover(){T._pool.push(this),this.instanceElementList.clear()}destroy(){super.destroy()}}T._instanceBufferStateMap=new Map,T.MaxInstanceCount=1024,T._pool=[],T._bufferPool=new Map;class E{get shadowCasterCommanBuffer(){return this._shadowCasterCommanBuffer}set shadowCasterCommanBuffer(e){this._shadowCasterCommanBuffer=e}set light(e){this._light=e;var a=t.Matrix4x4.TEMP,r=a.elements,s=this._lightup,i=this._lightSide,n=this._lightForward;t.Matrix4x4.createFromQuaternion(this._light.transform.rotation,a),i.setValue(r[0],r[1],r[2]),s.setValue(r[4],r[5],r[6]),n.setValue(-r[8],-r[9],-r[10]);var o=this._light.shadowResolution,h=this.shadowCastMode=this._light.shadowCascadesMode;if(h==t.ShadowCascadesMode.NoCascades)this._cascadeCount=1,this._shadowTileResolution=o,this._shadowMapWidth=o,this._shadowMapHeight=o;else{this._cascadeCount=h==t.ShadowCascadesMode.TwoCascades?2:4;let e=t.ShadowUtils.getMaxTileResolutionInAtlas(o,o,this._cascadeCount);this._shadowTileResolution=e,this._shadowMapWidth=2*e,this._shadowMapHeight=h==t.ShadowCascadesMode.TwoCascades?e:2*e}}get light(){return this._light}constructor(){this._cascadesSplitDistance=new Array(E._maxCascades+1),this._shadowMatrices=new Float32Array(16*E._maxCascades),this._splitBoundSpheres=new Float32Array(4*E._maxCascades),this._shadowSliceDatas=[new t.ShadowSliceData,new t.ShadowSliceData,new t.ShadowSliceData,new t.ShadowSliceData],this._shadowMapSize=new t.Vector4,this._shadowBias=new t.Vector4,this._cascadeCount=0,this._shadowMapWidth=0,this._shadowMapHeight=0,this._shadowTileResolution=0,this._lightup=new t.Vector3,this._lightSide=new t.Vector3,this._lightForward=new t.Vector3,this._cascadesSplitDistance=new Array(E._maxCascades+1),this._renderQueue=new i(!1),this._frustumPlanes=new Array(new t.Plane(new t.Vector3,0),new t.Plane(new t.Vector3,0),new t.Plane(new t.Vector3,0),new t.Plane(new t.Vector3,0),new t.Plane(new t.Vector3,0),new t.Plane(new t.Vector3,0)),this._shadowCullInfo=new t.ShadowCullInfo}update(e){var a=this._cascadesSplitDistance,r=this._frustumPlanes,s=this.camera.nearplane,i=Math.min(this.camera.farplane,this._light.shadowDistance),n=this._shadowMatrices,o=this._splitBoundSpheres;t.ShadowUtils.getCascadesSplitDistance(this._light.shadowTwoCascadeSplits,this._light._shadowFourCascadeSplits,s,i,this.camera.fieldOfView*t.MathUtils3D.Deg2Rad,this.camera.aspectRatio,this.shadowCastMode,a),t.ShadowUtils.getCameraFrustumPlanes(this.camera._projectViewMatrix,r);var h=t.Vector3.TEMP;this.camera.transform.getForward(h),t.Vector3.normalize(h,h);for(var d=0;d<this._cascadeCount;d++){var l=this._shadowSliceDatas[d];l.sphereCenterZ=t.ShadowUtils.getBoundSphereByFrustum(a[d],a[d+1],this.camera.fieldOfView*t.MathUtils3D.Deg2Rad,this.camera.aspectRatio,this.camera.transform.position,h,l.splitBoundSphere),t.ShadowUtils.getDirectionLightShadowCullPlanes(r,d,a,s,this._lightForward,l),t.ShadowUtils.getDirectionalLightMatrices(this._lightup,this._lightSide,this._lightForward,d,this._light.shadowNearPlane,this._shadowTileResolution,l,n),this._cascadeCount>1&&t.ShadowUtils.applySliceTransform(l,this._shadowMapWidth,this._shadowMapHeight,d,n)}t.ShadowUtils.prepareShadowReceiverShaderValues(this._shadowMapWidth,this._shadowMapHeight,this._shadowSliceDatas,this._cascadeCount,this._shadowMapSize,n,o)}render(e,r,s){let i=e.sceneData;e.pipelineMode="ShadowCaster";var n=this.destTarget;e.setRenderTarget(n,t.RenderClearFlag.Depth),e.setClearData(t.RenderClearFlag.Depth,t.Color.BLACK,1,0);let o=e.cameraData,h=e.invertY;for(var d=0,l=this._cascadeCount;d<l;d++){var c=this._shadowSliceDatas[d];this.getShadowBias(c.projectionMatrix,c.resolution,this._shadowBias),this._setupShadowCasterShaderValues(i,c,this._lightForward,this._shadowBias);var _=this._shadowCullInfo;_.position=c.position,_.cullPlanes=c.cullPlanes,_.cullPlaneCount=c.cullPlaneCount,_.cullSphere=c.splitBoundSphere,_.direction=this._lightForward;var u=performance.now();a.cullDirectLightShadow(_,r,s,this._renderQueue,e),t.LayaGL.statAgent.recordTimeData(t.StatElement.T_CullShadow,performance.now()-u),e.cameraData=c.cameraShaderValue,e.invertY=!1,e.cameraUpdateMask++;var p=c.resolution,D=c.offsetX,m=c.offsetY;this._renderQueue.elements.length>0?(t.Viewport.TEMP.set(D,m,p,p),t.Vector4.TEMP.setValue(D+1,m+1,p-2,p-2),e.setViewPort(t.Viewport.TEMP),e.setScissor(t.Vector4.TEMP)):(t.Viewport.TEMP.set(D,m,p,p),e.setViewPort(t.Viewport.TEMP),t.Vector4.TEMP.setValue(D,m,p,p),e.setScissor(t.Vector4.TEMP)),e.setClearData(t.RenderClearFlag.Depth,t.Color.BLACK,1,0),this._renderQueue.renderQueue(e),t.LayaGL.statAgent.recordCTData(t.StatElement.CT_ShadowDrawCall,this._renderQueue.elements.length),this._applyCasterPassCommandBuffer(e)}this._applyRenderData(e.sceneData,e.cameraData),this._renderQueue._batch.recoverData(),e.cameraData=o,e.invertY=h,e.cameraUpdateMask++}_applyRenderData(e,a){var r=this._light;switch(r.shadowCascadesMode!==t.ShadowCascadesMode.NoCascades?e.addDefine(t.Scene3DShaderDeclaration.SHADERDEFINE_SHADOW_CASCADE):e.removeDefine(t.Scene3DShaderDeclaration.SHADERDEFINE_SHADOW_CASCADE),r.shadowMode){case t.ShadowMode.Hard:e.removeDefine(t.Scene3DShaderDeclaration.SHADERDEFINE_SHADOW_SOFT_SHADOW_LOW),e.removeDefine(t.Scene3DShaderDeclaration.SHADERDEFINE_SHADOW_SOFT_SHADOW_HIGH);break;case t.ShadowMode.SoftLow:e.addDefine(t.Scene3DShaderDeclaration.SHADERDEFINE_SHADOW_SOFT_SHADOW_LOW),e.removeDefine(t.Scene3DShaderDeclaration.SHADERDEFINE_SHADOW_SOFT_SHADOW_HIGH);break;case t.ShadowMode.SoftHigh:e.addDefine(t.Scene3DShaderDeclaration.SHADERDEFINE_SHADOW_SOFT_SHADOW_HIGH),e.removeDefine(t.Scene3DShaderDeclaration.SHADERDEFINE_SHADOW_SOFT_SHADOW_LOW)}e.setBuffer(t.ShadowCasterPass.SHADOW_MATRICES,this._shadowMatrices),e.setVector(t.ShadowCasterPass.SHADOW_MAP_SIZE,this._shadowMapSize),e.setBuffer(t.ShadowCasterPass.SHADOW_SPLIT_SPHERES,this._splitBoundSpheres)}_applyCasterPassCommandBuffer(e){this.shadowCasterCommanBuffer&&0!=this.shadowCasterCommanBuffer.length&&this.shadowCasterCommanBuffer.forEach(function(e){e._apply()})}getShadowBias(e,a,r){var s=2/e.elements[0]/a,i=-this._light.shadowDepthBias*s,n=-this._light.shadowNormalBias*s;if(this._light.shadowMode==t.ShadowMode.SoftHigh){const e=2.5;i*=e,n*=e}r.setValue(i,n,0,0)}_setupShadowCasterShaderValues(e,a,r,s){e.setVector(t.ShadowCasterPass.SHADOW_BIAS,s),e.setVector3(t.ShadowCasterPass.SHADOW_LIGHT_DIRECTION,r);var i=a.cameraShaderValue;i.setMatrix4x4(t.BaseCamera.VIEWMATRIX,a.viewMatrix),i.setMatrix4x4(t.BaseCamera.PROJECTMATRIX,a.projectionMatrix),i.setMatrix4x4(t.BaseCamera.VIEWPROJECTMATRIX,a.viewProjectMatrix),e.setMatrix4x4(t.BaseCamera.VIEWPROJECTMATRIX,a.viewProjectMatrix)}destroy(){for(var e=0;e<this._shadowSliceDatas.length;e++)this._shadowSliceDatas[e].destroy();this._renderQueue.destroy(),this._cascadesSplitDistance=null,this._frustumPlanes=null,this._shadowMatrices=null,this._splitBoundSpheres=null}}E._maxCascades=4;class b{get sceneData(){return this._sceneData}set sceneData(e){if(this._sceneData=e,t.Config._uniformBlock&&this.sceneData)for(let e of this._preDrawUniformMaps){let a=t.LayaGL.renderDeviceFactory.createGlobalUniformMap(e);a._idata.size>0&&this.sceneData.createUniformBuffer(e,a._idata)}}get cameraData(){return this._cameraData}set cameraData(e){if(this._cameraData=e,t.Config._uniformBlock&&this.cameraData){let e=t.LayaGL.renderDeviceFactory.createGlobalUniformMap("BaseCamera");this.cameraData.createUniformBuffer("BaseCamera",e._idata)}}get sceneModuleData(){return this._sceneModuleData}set sceneModuleData(e){this._sceneModuleData=e}get cameraModuleData(){return this._cameraModuleData}set cameraModuleData(e){this._cameraModuleData=e}get globalShaderData(){return this._globalShaderData}set globalShaderData(e){this._globalShaderData=e}_getContextShaderDefines(){return this._cacheGlobalDefines}_prepareContext(){let e=this._cacheGlobalDefines;if(this.sceneData){this.sceneData._defineDatas.cloneTo(e);for(let e of this._preDrawUniformMaps)this.sceneData.updateUBOBuffer(e)}else this._globalConfigShaderData.cloneTo(e);this.cameraData&&(e.addDefineDatas(this.cameraData._defineDatas),this.cameraData.updateUBOBuffer("BaseCamera"))}setRenderTarget(e,t){this._clearFlag=t,e!=this._renderTarget&&(this._renderTarget=e,this._needStart=!0)}setViewPort(e){this._viewPort=e,this._needStart=!0}setScissor(e){this._scissor=e,this._needStart=!0}get sceneUpdataMask(){return this._sceneUpdataMask}set sceneUpdataMask(e){this._sceneUpdataMask=e}get cameraUpdateMask(){return this._cameraUpdateMask}set cameraUpdateMask(e){this._cameraUpdateMask=e}get pipelineMode(){return this._pipelineMode}set pipelineMode(e){this._pipelineMode=e}get invertY(){return this._invertY}set invertY(e){this._invertY=e}constructor(){this._cacheGlobalDefines=new t.WebDefineDatas,this._needStart=!0,this._clearColor=new t.Color,this._globalConfigShaderData=t.Shader3D._configDefineValues,this._preDrawUniformMaps=new Set,this.cameraUpdateMask=0,b._instance=this}runOneCMD(e){e.apply(this)}runCMDList(e){e.forEach(e=>{e.apply(this)})}setClearData(e,t,a,r){return this._clearFlag=e,t.cloneTo(this._clearColor),this._clearDepth=a,this._clearStencil=r,0}drawRenderElementList(e){this._needStart&&(this._bindRenderTarget(),this._start(),this._needStart=!1);let a=performance.now();this._prepareContext();let r=e.elements;for(var s=0,i=e.length;s<i;s++)r[s]._preUpdatePre(this);let n=t.WebGLEngine.instance.bufferMgr;n&&n.upload(),t.LayaGL.statAgent.recordTimeData(t.StatElement.T_3DContextPre,performance.now()-a),a=performance.now();for(s=0,i=e.length;s<i;s++)r[s]._render(this);return t.LayaGL.statAgent.recordTimeData(t.StatElement.T_3DContextRender,performance.now()-a),t.LayaGL.statAgent.recordCTData(t.StatElement.CT_3DDrawCall,e.length),t.LayaGL.renderEngine._framePassCount++,0}drawRenderElementOne(e){this._needStart&&(this._bindRenderTarget(),this._start(),this._needStart=!1),this._prepareContext(),e._preUpdatePre(this);let a=t.WebGLEngine.instance.bufferMgr;return a&&a.upload(),e._render(this),t.LayaGL.statAgent.recordCTData(t.StatElement.CT_3DDrawCall,1),t.LayaGL.renderEngine._framePassCount++,0}_bindRenderTarget(){this._renderTarget?t.LayaGL.textureContext.bindRenderTarget(this._renderTarget):t.LayaGL.textureContext.bindoutScreenTarget()}_start(){t.WebGLEngine.instance.scissorTest(!0),t.WebGLEngine.instance.viewport(this._viewPort.x,this._viewPort.y,this._viewPort.width,this._viewPort.height),t.WebGLEngine.instance.scissor(this._viewPort.x,this._viewPort.y,this._viewPort.width,this._viewPort.height),this._clearFlag!=t.RenderClearFlag.Nothing&&t.WebGLEngine.instance.clearRenderTexture(this._clearFlag,this._clearColor,this._clearDepth,this._clearStencil),t.WebGLEngine.instance.scissor(this._scissor.x,this._scissor.y,this._scissor.z,this._scissor.w)}clearRenderTarget(){this._bindRenderTarget(),this._start()}}class L{get enableOpaqueTexture(){return this._enableOpaqueTexture}set enableOpaqueTexture(e){this._enableOpaqueTexture=e}setViewPort(e){e.cloneTo(this._viewPort)}setScissor(e){e.cloneTo(this._scissor)}constructor(){this.blitOpaqueBuffer=new t.CommandBuffer,this.opaqueList=new i(!1),this.transparent=new i(!0),this.cameraCullInfo=new t.CameraCullInfo,this._zBufferParams=new t.Vector4,this._scissor=new t.Vector4,this._viewPort=new t.Viewport,this._defaultNormalDepthColor=new t.Color(.5,.5,1,0),this.clearColor=new t.Color,this.depthPipelineMode="ShadowCaster",this.depthNormalPipelineMode="DepthNormal";let e=b._instance;e._preDrawUniformMaps.add("Scene3D"),e._preDrawUniformMaps.add("Shadow"),e._preDrawUniformMaps.add("Global")}setCameraCullInfo(e){this.cameraCullInfo.position=e._transform.position,this.cameraCullInfo.cullingMask=e.cullingMask,this.cameraCullInfo.staticMask=e.staticMask,this.cameraCullInfo.boundFrustum=e.boundFrustum,this.cameraCullInfo.useOcclusionCulling=e.useOcclusionCulling}setBeforeForwardCmds(e){e&&e.length>0&&(this.beforeForwardCmds=e,e.forEach(e=>{e._apply(!1)}))}setBeforeSkyboxCmds(e){e&&e.length>0&&(this.beforeSkyboxCmds=e,e.forEach(e=>{e._apply(!1)}))}setBeforeTransparentCmds(e){e&&e.length>0&&(this.beforeTransparentCmds=e,e.forEach(e=>{e._apply(!1)}))}render(e,r,s){e.cameraUpdateMask++,this.opaqueList.clear(),this.transparent.clear();var i=performance.now();a.cullByCameraCullInfo(this.cameraCullInfo,r,s,this.opaqueList,this.transparent,e),t.LayaGL.statAgent.recordTimeData(t.StatElement.T_CullMain,performance.now()-i),i=performance.now(),0!=(this.depthTextureMode&t.DepthTextureMode.Depth)&&this._renderDepthPass(e),0!=(this.depthTextureMode&t.DepthTextureMode.DepthNormals)&&this._renderDepthNormalPass(e),t.LayaGL.statAgent.recordTimeData(t.StatElement.T_DepthPass,performance.now()-i),this._viewPort.cloneTo(L._context3DViewPortCatch),this._scissor.cloneTo(L._contextScissorPortCatch),i=performance.now(),this._mainPass(e),t.LayaGL.statAgent.recordTimeData(t.StatElement.T_3DMainPass,performance.now()-i),this.opaqueList._batch.recoverData()}_renderDepthPass(e){e.pipelineMode=this.depthPipelineMode;var a=this._viewPort,r=e.sceneData;r.addDefine(t.DepthPass.DEPTHPASS),r.setVector(t.DepthPass.DEFINE_SHADOW_BIAS,t.Vector4.ZERO),t.Viewport.TEMP.set(a.x,a.y,a.width,a.height),t.Vector4.TEMP.setValue(a.x,a.y,a.width,a.height),e.setViewPort(t.Viewport.TEMP),e.setScissor(t.Vector4.TEMP),e.setRenderTarget(this.depthTarget,t.RenderClearFlag.Depth),e.setClearData(t.RenderClearFlag.Depth,t.Color.BLACK,1,0),this.opaqueList.renderQueue(e),t.LayaGL.statAgent.recordCTData(t.StatElement.CT_DepthCastDrawCall,this.opaqueList.elements.length);var s=this.camera.farplane,i=this.camera.nearplane;this._zBufferParams.setValue(1-s/i,s/i,(i-s)/(i*s),1/i),e.cameraData.setVector(t.DepthPass.DEFINE_SHADOW_BIAS,t.DepthPass.SHADOW_BIAS),e.cameraData.setVector(t.DepthPass.DEPTHZBUFFERPARAMS,this._zBufferParams),r.removeDefine(t.DepthPass.DEPTHPASS)}_transparentListRender(e){this.transparent.renderQueue(e)}_opaqueListRender(e){this.opaqueList.renderQueue(e)}_renderDepthNormalPass(e){e.pipelineMode=this.depthNormalPipelineMode;var a=this._viewPort;t.Viewport.TEMP.set(a.x,a.y,a.width,a.height),t.Vector4.TEMP.setValue(a.x,a.y,a.width,a.height),e.setViewPort(t.Viewport.TEMP),e.setScissor(t.Vector4.TEMP),e.setClearData(t.RenderClearFlag.Color|t.RenderClearFlag.Depth,this._defaultNormalDepthColor,1,0),e.setRenderTarget(this.depthNormalTarget,t.RenderClearFlag.Color|t.RenderClearFlag.Depth),this.opaqueList.renderQueue(e),t.LayaGL.statAgent.recordCTData(t.StatElement.CT_DepthCastDrawCall,this.opaqueList.elements.length)}opaqueTexturePass(e){let t=this.blitOpaqueBuffer;t._apply(!1),e.runCMDList(t._renderCMDs)}_mainPass(e){e.pipelineMode=this.pipelineMode,this._rendercmd(this.beforeForwardCmds,e),this._recoverRenderContext3D(e),e.setClearData(this.clearFlag,this.clearColor,1,0);var a=performance.now();if(this.enableOpaque&&this._opaqueListRender(e),t.LayaGL.statAgent.recordTimeData(t.StatElement.T_3DMainPass_Opaque,performance.now()-a),this._rendercmd(this.beforeSkyboxCmds,e),this.skyRenderNode){let t=this.skyRenderNode.renderelements[0];e.drawRenderElementOne(t)}this.enableOpaque&&this.opaqueTexturePass(e),this._rendercmd(this.beforeTransparentCmds,e),this._recoverRenderContext3D(e),a=performance.now(),this.transparent&&this._transparentListRender(e),t.LayaGL.statAgent.recordTimeData(t.StatElement.T_3DMainPass_Trans,performance.now()-a)}_rendercmd(e,t){e&&0!=e.length&&e.forEach(function(e){t.runCMDList(e._renderCMDs)})}_recoverRenderContext3D(e){const a=L._context3DViewPortCatch,r=L._contextScissorPortCatch;e.setViewPort(a),e.setScissor(r),e.setRenderTarget(this.destTarget,t.RenderClearFlag.Nothing)}destroy(){this.cameraCullInfo=null,this.beforeForwardCmds=null,this.beforeSkyboxCmds=null,this.beforeTransparentCmds=null,this.blitOpaqueBuffer.clear(),this.blitOpaqueBuffer=null,this.opaqueList.destroy(),this.transparent.destroy()}}L._context3DViewPortCatch=new t.Viewport(0,0,0,0),L._contextScissorPortCatch=new t.Vector4(0,0,0,0);class I{set light(e){this._light=e,this._shadowResolution=this._light.shadowResolution,this._lightWorldMatrix=this._light.getWorldMatrix(this._lightWorldMatrix),this._lightPos=this._light.transform.position,this._spotAngle=this._light.spotAngle,this._spotRange=this._light.spotRange}get light(){return this._light}constructor(){this._shadowSpotMapSize=new t.Vector4,this._shadowSpotMatrices=new t.Matrix4x4,this._renderQueue=new i(!1),this._shadowSpotData=new t.ShadowSpotData,this._lightWorldMatrix=new t.Matrix4x4,this._shadowBias=new t.Vector4}update(e){var t=this._shadowSpotData;this._getSpotLightShadowData(t,this._shadowResolution,this._shadowSpotMatrices,this._shadowSpotMapSize)}render(e,r,s){let i=e.cameraData;var n=e.sceneData;e.pipelineMode="ShadowCaster",e.setRenderTarget(this.destTarget,t.RenderClearFlag.Depth);var o=this._shadowSpotData;this._getShadowBias(o.resolution,this._shadowBias),this._setupShadowCasterShaderValues(n,o,this._shadowBias);var h=performance.now();a.cullSpotShadow(o.cameraCullInfo,r,s,this._renderQueue,e),t.LayaGL.statAgent.recordTimeData(t.StatElement.T_CullShadow,performance.now()-h),e.cameraData=o.cameraShaderValue,e.cameraUpdateMask++,t.Viewport.TEMP.set(o.offsetX,o.offsetY,o.resolution,o.resolution),t.Vector4.TEMP.setValue(o.offsetX,o.offsetY,o.resolution,o.resolution),e.setViewPort(t.Viewport.TEMP),e.setScissor(t.Vector4.TEMP),e.setClearData(t.RenderClearFlag.Depth,t.Color.BLACK,1,0),this._renderQueue.renderQueue(e),t.LayaGL.statAgent.recordCTData(t.StatElement.CT_ShadowDrawCall,this._renderQueue.elements.length),this._applyCasterPassCommandBuffer(e),this._applyRenderData(e.sceneData,e.cameraData),this._renderQueue._batch.recoverData(),e.cameraData=i,e.cameraUpdateMask++}_getSpotLightShadowData(e,a,r,s){var i=e.position=this._lightPos;e.resolution=a,s.setValue(1/a,1/a,a,a),e.offsetX=0,e.offsetY=0;var n=this._lightWorldMatrix,o=e.viewMatrix,h=e.projectionMatrix,d=e.viewProjectMatrix,l=e.cameraCullInfo.boundFrustum;n.invert(o),t.Matrix4x4.createPerspective(3.1416*this._spotAngle/180,1,.1,this._spotRange,h),t.Matrix4x4.multiply(h,o,d),l.matrix=d,d.cloneTo(r),e.cameraCullInfo.position=i}_getShadowBias(e,a){var r=Math.tan(.5*this._spotAngle*t.MathUtils3D.Deg2Rad)*this._spotRange/e,s=-this._light.shadowDepthBias*r,i=-this._light.shadowNormalBias*r;if(this._shadowMode==t.ShadowMode.SoftHigh){const e=2.5;s*=e,i*=e}a.setValue(s,i,0,0)}_setupShadowCasterShaderValues(e,a,r){e.setVector(t.ShadowCasterPass.SHADOW_BIAS,r);var s=a.cameraShaderValue;s.setMatrix4x4(t.BaseCamera.VIEWMATRIX,a.viewMatrix),s.setMatrix4x4(t.BaseCamera.PROJECTMATRIX,a.projectionMatrix),s.setMatrix4x4(t.BaseCamera.VIEWPROJECTMATRIX,a.viewProjectMatrix),e.setMatrix4x4(t.BaseCamera.VIEWPROJECTMATRIX,a.viewProjectMatrix)}_applyCasterPassCommandBuffer(e){this.shadowCasterCommanBuffer&&0!=this.shadowCasterCommanBuffer.length&&this.shadowCasterCommanBuffer.forEach(function(e){e._apply()})}_applyRenderData(e,a){switch(this._light.shadowMode){case t.ShadowMode.Hard:e.removeDefine(t.Scene3DShaderDeclaration.SHADERDEFINE_SHADOW_SPOT_SOFT_SHADOW_HIGH),e.removeDefine(t.Scene3DShaderDeclaration.SHADERDEFINE_SHADOW_SPOT_SOFT_SHADOW_LOW);break;case t.ShadowMode.SoftLow:e.addDefine(t.Scene3DShaderDeclaration.SHADERDEFINE_SHADOW_SPOT_SOFT_SHADOW_LOW),e.removeDefine(t.Scene3DShaderDeclaration.SHADERDEFINE_SHADOW_SPOT_SOFT_SHADOW_HIGH);break;case t.ShadowMode.SoftHigh:e.addDefine(t.Scene3DShaderDeclaration.SHADERDEFINE_SHADOW_SPOT_SOFT_SHADOW_HIGH),e.removeDefine(t.Scene3DShaderDeclaration.SHADERDEFINE_SHADOW_SPOT_SOFT_SHADOW_LOW)}e.setMatrix4x4(t.ShadowCasterPass.SHADOW_SPOTMATRICES,this._shadowSpotMatrices),e.setVector(t.ShadowCasterPass.SHADOW_SPOTMAP_SIZE,this._shadowSpotMapSize)}destroy(){this._shadowSpotData.destroy()}}class x{constructor(){this.shadowCastPass=!1,this.enableDirectLightShadow=!1,this.enableSpotLightShadowPass=!1,this.enablePostProcess=!0,this.directLightShadowPass=new E,this.spotLightShadowPass=new I,this.shadowParams=new t.Vector4,this.renderpass=new L,this.finalize=new t.CommandBuffer}setBeforeImageEffect(e){e&&e.length>0&&(this._beforeImageEffectCMDS=e,e.forEach(e=>{e._apply(!1)}))}setAfterEventCmd(e){e&&e.length>0&&(this._afterAllRenderCMDS=e,e.forEach(e=>{e._apply(!1)}))}destroy(){this._afterAllRenderCMDS=null,this._beforeImageEffectCMDS=null,this.renderpass.destroy(),this.directLightShadowPass.destroy(),this.spotLightShadowPass.destroy(),this.finalize.clear(),this.finalize=null}}const y=new t.Viewport(0,0,0,0),A=new t.Vector4;class V{constructor(){this.renderpass=new x}initRenderpass(e,a){let r=this.renderpass.renderpass,s=e._getRenderTexture(),i=0,n=e.clearFlag;n!=t.CameraClearFlags.Sky||e.scene.skyRenderer._isAvailable()||(n=t.CameraClearFlags.SolidColor);let o=s.depthStencilFormat==t.RenderTargetFormat.DEPTHSTENCIL_24_8?t.RenderClearFlag.Stencil:0;switch(n){case t.CameraClearFlags.DepthOnly:case t.CameraClearFlags.Sky:i=t.RenderClearFlag.Depth|o;break;case t.CameraClearFlags.Nothing:i=0;break;case t.CameraClearFlags.ColorOnly:i=t.RenderClearFlag.Color;break;case t.CameraClearFlags.SolidColor:default:i=t.RenderClearFlag.Color|t.RenderClearFlag.Depth|o}let h=e._linearClearColor;h=1!=s.gammaCorrection?e.clearColor:e._linearClearColor,r.camera=e._renderDataModule,r.destTarget=s._renderTarget,r.clearFlag=i,r.clearColor=h;let d=e._needInternalRenderTexture();d?y.set(0,0,s.width,s.height):e.viewport.cloneTo(y),r.setViewPort(y);let l=t.Vector4.TEMP;l.setValue(y.x,y.y,y.width,y.height),r.setScissor(l),r.enableOpaque=t.Stat.enableOpaque,r.enableTransparent=t.Stat.enableTransparent,r.enableCMD=t.Stat.enableCameraCMD,r.setBeforeSkyboxCmds(e._cameraEventCommandBuffer[t.CameraEventFlags.BeforeSkyBox]),r.setBeforeForwardCmds(e._cameraEventCommandBuffer[t.CameraEventFlags.BeforeForwardOpaque]),r.setBeforeTransparentCmds(e._cameraEventCommandBuffer[t.CameraEventFlags.BeforeTransparent]),this.renderpass.setBeforeImageEffect(e._cameraEventCommandBuffer[t.CameraEventFlags.BeforeImageEffect]),this.renderpass.setAfterEventCmd(e._cameraEventCommandBuffer[t.CameraEventFlags.AfterEveryThing]),r.setCameraCullInfo(e),n==t.CameraClearFlags.Sky?r.skyRenderNode=e.scene.skyRenderer._baseRenderNode:r.skyRenderNode=null,r.pipelineMode=t.RenderContext3D._instance.configPipeLineMode;let c=t.Scene3D._updateMark%e.scene._ShadowMapupdateFrequency==0&&t.Stat.enableShadow;if(this.renderpass.shadowCastPass=c,c){let r=this.renderpass.shadowParams;r.setValue(0,0,0,0);let s=a.sceneData,i=e.scene._mainDirectionLight,n=i&&i.shadowMode!=t.ShadowMode.None;if(this.renderpass.enableDirectLightShadow=n,n){this.renderpass.directLightShadowPass.camera=e._renderDataModule,this.renderpass.directLightShadowPass.light=i._dataModule;let a=t.ILaya.Scene3D._shadowCasterPass.getDirectLightShadowMap(i);this.renderpass.directLightShadowPass.destTarget=a._renderTarget,r.x=this.renderpass.directLightShadowPass.light.shadowStrength,s.setTexture(t.ShadowCasterPass.SHADOW_MAP,a)}let o=e.scene._mainSpotLight,h=o&&o.shadowMode!=t.ShadowMode.None;if(this.renderpass.enableSpotLightShadowPass=h,h){this.renderpass.spotLightShadowPass.light=o._dataModule;let e=t.ILaya.Scene3D._shadowCasterPass.getSpotLightShadowPassData(o);this.renderpass.spotLightShadowPass.destTarget=e._renderTarget,r.y=this.renderpass.spotLightShadowPass.light.shadowStrength,s.setTexture(t.ShadowCasterPass.SHADOW_SPOTMAP,e)}s.setVector(t.ShadowCasterPass.SHADOW_PARAMS,this.renderpass.shadowParams)}r.blitOpaqueBuffer.clear();let _=e.opaquePass;if(r.enableOpaqueTexture=_,_&&(r.opaqueTexture=e._opaqueTexture._renderTarget,r.blitOpaqueBuffer.blitScreenQuad(s,e._opaqueTexture)),t.Stat.enablePostprocess&&e.postProcess&&e.postProcess.enable&&e.postProcess.effects.length>0?(this.renderpass.enablePostProcess=t.Stat.enablePostprocess,this.renderpass.postProcess=e.postProcess._context.command,e.postProcess._render(e),this.renderpass.postProcess._apply(!1)):this.renderpass.enablePostProcess=!1,this.renderpass.finalize.clear(),!this.renderpass.enablePostProcess&&d&&e._offScreenRenderTexture){let t=e._offScreenRenderTexture;A.setValue(e.normalizedViewport.x,1-e.normalizedViewport.y,s.width/t.width,-s.height/t.height),this.renderpass.finalize.blitScreenQuad(s,e._offScreenRenderTexture,A)}}renderDepth(e){let a=e.depthTextureMode;e.postProcess&&e.postProcess.enable&&(a|=e.postProcess.cameraDepthTextureMode),0!=(a&t.DepthTextureMode.Depth)&&(t.Camera.depthPass.getTarget(e,t.DepthTextureMode.Depth,e.depthTextureFormat),this.renderpass.renderpass.depthTarget=e.depthTexture._renderTarget,t.Camera.depthPass._setupDepthModeShaderValue(t.DepthTextureMode.Depth,e)),0!=(a&t.DepthTextureMode.DepthNormals)&&(t.Camera.depthPass.getTarget(e,t.DepthTextureMode.DepthNormals,e.depthTextureFormat),this.renderpass.renderpass.depthNormalTarget=e.depthNormalTexture._renderTarget,e._shaderValues.setTexture(t.DepthPass.DEPTHNORMALSTEXTURE,e.depthNormalTexture),t.Camera.depthPass._setupDepthModeShaderValue(t.DepthTextureMode.DepthNormals,e)),this.renderpass.renderpass.depthTextureMode=a}fowardRender(e,a){t.Camera.depthPass.cleanUp(a),this.renderDepth(a),this.initRenderpass(a,e);let r=this.render3DManager.baseRenderList.elements,s=this.render3DManager.baseRenderList.length;this.renderFowarAddCameraPass(e,this.renderpass,r,s)}renderFowarAddCameraPass(e,a,r,s){var i=performance.now();a.shadowCastPass&&(a.enableDirectLightShadow&&(e.sceneData.addDefine(t.Scene3DShaderDeclaration.SHADERDEFINE_SHADOW),e.sceneData.removeDefine(t.Scene3DShaderDeclaration.SHADERDEFINE_SHADOW_SPOT),a.directLightShadowPass.update(e),a.directLightShadowPass.render(e,r,s)),a.enableSpotLightShadowPass&&(e.sceneData.addDefine(t.Scene3DShaderDeclaration.SHADERDEFINE_SHADOW_SPOT),e.sceneData.removeDefine(t.Scene3DShaderDeclaration.SHADERDEFINE_SHADOW),a.spotLightShadowPass.update(e),a.spotLightShadowPass.render(e,r,s)),a.enableDirectLightShadow?e.sceneData.addDefine(t.Scene3DShaderDeclaration.SHADERDEFINE_SHADOW):e.sceneData.removeDefine(t.Scene3DShaderDeclaration.SHADERDEFINE_SHADOW),a.enableSpotLightShadowPass?e.sceneData.addDefine(t.Scene3DShaderDeclaration.SHADERDEFINE_SHADOW_SPOT):e.sceneData.removeDefine(t.Scene3DShaderDeclaration.SHADERDEFINE_SHADOW_SPOT)),t.LayaGL.statAgent.recordTimeData(t.StatElement.T_ShadowPass,performance.now()-i),a.renderpass.render(e,r,s),a._beforeImageEffectCMDS&&this._rendercmd(a._beforeImageEffectCMDS,e),a.enablePostProcess&&(i=performance.now(),a.postProcess&&this._renderPostProcess(a.postProcess,e),t.LayaGL.statAgent.recordTimeData(t.StatElement.T_Render_PostProcess,performance.now()-i)),a._afterAllRenderCMDS&&this._rendercmd(a._afterAllRenderCMDS,e),a.finalize._apply(!1),e.runCMDList(a.finalize._renderCMDs)}_rendercmd(e,t){e&&0!=e.length&&e.forEach(function(e){t.runCMDList(e._renderCMDs)})}_renderPostProcess(e,t){t.runCMDList(e._renderCMDs)}destroy(){this.renderpass.destroy()}}class B extends t.DrawNodeCMDData{get node(){return this._node}set node(e){this._node=e}get destShaderData(){return this._destShaderData}set destShaderData(e){this._destShaderData=e}get destSubShader(){return this._destSubShader}set destSubShader(e){this._destSubShader=e}get subMeshIndex(){return this._subMeshIndex}set subMeshIndex(e){this._subMeshIndex=e}constructor(){super(),this.type=t.RenderCMDType.DrawNode}apply(e){if(this.destShaderData&&this.destSubShader)if(this.node._renderUpdatePre(e),-1==this.subMeshIndex)this.node.renderelements.forEach(t=>{let a=t.subShader,r=t.materialShaderData;t.subShader=this._destSubShader,t.materialShaderData=this._destShaderData,e.drawRenderElementOne(t),t.subShader=a,t.materialShaderData=r});else{let t=this.node.renderelements[this.subMeshIndex],a=t.subShader,r=t.materialShaderData;t.subShader=this._destSubShader,t.materialShaderData=this._destShaderData,e.drawRenderElementOne(t),t.subShader=a,t.materialShaderData=r}}}class F extends t.BlitQuadCMDData{get dest(){return this._dest}set dest(e){this._dest=e}get viewport(){return this._viewport}set viewport(e){e.cloneTo(this._viewport)}get scissor(){return this._scissor}set scissor(e){e.cloneTo(this._scissor)}get source(){return this._source}set source(e){this._source=e,this._source&&this._sourceTexelSize.setValue(1/this._source.width,1/this._source.height,this._source.width,this._source.height)}get offsetScale(){return this._offsetScale}set offsetScale(e){e.cloneTo(this._offsetScale)}get element(){return this._element}set element(e){this._element=e}constructor(){super(),this.type=t.RenderCMDType.Blit,this._viewport=new t.Viewport,this._scissor=new t.Vector4,this._offsetScale=new t.Vector4,this._sourceTexelSize=new t.Vector4}apply(e){this.element.materialShaderData._setInternalTexture(t.Command.SCREENTEXTURE_ID,this._source),this.element.materialShaderData.setVector(t.Command.SCREENTEXTUREOFFSETSCALE_ID,this._offsetScale),this.element.materialShaderData.setVector(t.Command.MAINTEXTURE_TEXELSIZE_ID,this._sourceTexelSize),e.setViewPort(this._viewport),e.setScissor(this._scissor),e.setRenderTarget(this.dest,t.RenderClearFlag.Nothing),e.drawRenderElementOne(this.element)}}class O extends t.DrawElementCMDData{constructor(){super(),this.type=t.RenderCMDType.DrawElement}setRenderelements(e){this._elemets=e}apply(e){1==this._elemets.length?e.drawRenderElementOne(this._elemets[0]):this._elemets.forEach(t=>{e.drawRenderElementOne(t)})}}class v extends t.SetViewportCMD{get viewport(){return this._viewport}set viewport(e){this._viewport=e}get scissor(){return this._scissor}set scissor(e){this._scissor=e}constructor(){super(),this.type=t.RenderCMDType.ChangeViewPort,this.scissor=new t.Vector4,this.viewport=new t.Viewport}apply(e){e.setViewPort(this.viewport),e.setScissor(this.scissor)}}const N=new t.Viewport,H=new t.Vector4;class G extends t.SetRenderTargetCMD{get rt(){return this._rt}set rt(e){this._rt=e}get clearFlag(){return this._clearFlag}set clearFlag(e){this._clearFlag=e}get clearColorValue(){return this._clearColorValue}set clearColorValue(e){e.cloneTo(this._clearColorValue)}get clearDepthValue(){return this._clearDepthValue}set clearDepthValue(e){this._clearDepthValue=e}get clearStencilValue(){return this._clearStencilValue}set clearStencilValue(e){this._clearStencilValue=e}constructor(){super(),this.type=t.RenderCMDType.ChangeRenderTarget,this._clearColorValue=new t.Color}apply(e){e.setRenderTarget(this.rt,t.RenderClearFlag.Nothing),e.setClearData(this.clearFlag,this.clearColorValue,this.clearDepthValue,this.clearStencilValue),this.rt&&(N.set(0,0,this.rt._textures[0].width,this.rt._textures[0].height),H.setValue(0,0,this.rt._textures[0].width,this.rt._textures[0].height),e.setViewPort(N),e.setScissor(H))}}class U extends P{constructor(){super()}drawGeometry(e){let a=this.geometry.drawParams.elements;if(!this.skinnedData)return;this.geometry.bufferState.bind();let r=e._cacheShaerVariable[t.SkinnedMeshRenderer.BONES];if(!r)for(var s=0,i=e._spriteUniformParamsMap._idata.length;s<i;s++)if(e._spriteUniformParamsMap._idata[s].dataOffset==t.SkinnedMeshRenderer.BONES){r=e._spriteUniformParamsMap._idata[s],e._cacheShaerVariable[t.SkinnedMeshRenderer.BONES]=r;break}for(var n=0,o=this.geometry.drawParams.length/2;n<o;n++){var h=this.skinnedData[n];t.WebGLEngine.instance.uploadOneUniforms(e._renderShaderInstance,r,h);var d=2*n;t.WebGLEngine.instance.getDrawContext().drawElements(this.geometry._glmode,a[d+1],this.geometry._glindexFormat,a[d])}}}n.BaseRenderNodeClass=n;class k{createInstanceBatch(){return new R}createSetRenderDataCMD(){return new t.WebGLSetRenderData}createSetShaderDefineCMD(){return new t.WebGLSetShaderDefine}createDrawNodeCMDData(){return new B}createBlitQuadCMDData(){return new F}createDrawElementCMDData(){return new O}createSetViewportCMD(){return new v}createSetRenderTargetCMD(){return new G}createSceneRenderManager(){return new M}createSkinRenderElement(){return new U}createRenderContext3D(){return new b}createRenderElement3D(){return new P}createInstanceRenderElement3D(){return T.create()}createRender3DProcess(){return new V}}t.Laya.addBeforeInitCallback(()=>{t.Laya3DRender.Render3DPassFactory||(t.Laya3DRender.Render3DPassFactory=new k)}),e.ForwardAddClusterRP=class{setViewPort(e){e.cloneTo(this._viewPort)}setScissor(e){e.cloneTo(this._scissor)}constructor(){this._opaqueList=new i(!1),this._transparent=new i(!0),this.cameraCullInfo=new t.CameraCullInfo,this._zBufferParams=new t.Vector4,this._scissor=new t.Vector4,this._viewPort=new t.Viewport,this._defaultNormalDepthColor=new t.Color(.5,.5,1,0),this.clearColor=new t.Color,this.depthPipelineMode="ShadowCaster",this.depthNormalPipelineMode="DepthNormal"}setCameraCullInfo(e){this.cameraCullInfo.position=e._transform.position,this.cameraCullInfo.cullingMask=e.cullingMask,this.cameraCullInfo.staticMask=e.staticMask,this.cameraCullInfo.boundFrustum=e.boundFrustum,this.cameraCullInfo.useOcclusionCulling=e.useOcclusionCulling}setBeforeForwardCmds(e){e&&e.length>0&&(this.beforeForwardCmds=e,e.forEach(e=>e._apply(!1)))}setBeforeSkyboxCmds(e){e&&e.length>0&&(this.beforeSkyboxCmds=e,e.forEach(e=>e._apply(!1)))}setBeforeTransparentCmds(e){e&&e.length>0&&(this.beforeTransparentCmds=e,e.forEach(e=>e._apply(!1)))}render(e,r,s){e.cameraUpdateMask++,this._clearRenderList();var i=performance.now();a.cullByCameraCullInfo(this.cameraCullInfo,r,s,this._opaqueList,this._transparent,e),t.LayaGL.statAgent.recordTimeData(t.StatElement.T_CullMain,performance.now()-i),i=performance.now(),0!=(this.depthTextureMode&t.DepthTextureMode.Depth)&&this._renderDepthPass(e),0!=(this.depthTextureMode&t.DepthTextureMode.DepthNormals)&&this._renderDepthNormalPass(e),t.LayaGL.statAgent.recordTimeData(t.StatElement.T_DepthPass,performance.now()-i),this._cacheViewPortAndScissor(),i=performance.now(),this._mainPass(e),t.LayaGL.statAgent.recordTimeData(t.StatElement.T_3DMainPass,performance.now()-i),this._opaqueList._batch.recoverData()}_clearRenderList(){this._opaqueList.clear(),this._transparent.clear()}_cacheViewPortAndScissor(){this._viewPort.cloneTo(r.contextViewPortCache),this._scissor.cloneTo(r.contextScissorCache)}_renderDepthPass(e){e.pipelineMode=this.depthPipelineMode;const a=this._viewPort,r=e.sceneData;r.addDefine(t.DepthPass.DEPTHPASS),r.setVector(t.DepthPass.DEFINE_SHADOW_BIAS,t.Vector4.ZERO),t.Viewport.TEMP.set(a.x,a.y,a.width,a.height),t.Vector4.TEMP.setValue(a.x,a.y,a.width,a.height),e.setViewPort(t.Viewport.TEMP),e.setScissor(t.Vector4.TEMP),e.setRenderTarget(this.depthTarget,t.RenderClearFlag.Depth),e.setClearData(t.RenderClearFlag.Depth,t.Color.BLACK,1,0),this._opaqueList.renderQueue(e),t.LayaGL.statAgent.recordCTData(t.StatElement.CT_DepthCastDrawCall,this._opaqueList.elements.length);const s=this.camera.farPlane,i=this.camera.nearPlane;this._zBufferParams.setValue(1-s/i,s/i,(i-s)/(i*s),1/i),e.cameraData.setVector(t.DepthPass.DEFINE_SHADOW_BIAS,t.DepthPass.SHADOW_BIAS),e.cameraData.setVector(t.DepthPass.DEPTHZBUFFERPARAMS,this._zBufferParams),t.Camera.depthPass._setupDepthModeShaderValue(t.DepthTextureMode.Depth,this.camera),r.removeDefine(t.DepthPass.DEPTHPASS)}_renderDepthNormalPass(e){e.pipelineMode=this.depthNormalPipelineMode,this.camera._shaderValues.setTexture(t.DepthPass.DEPTHNORMALSTEXTURE,t.Texture2D.blackTexture);const a=this._viewPort;t.Viewport.TEMP.set(a.x,a.y,a.width,a.height),t.Vector4.TEMP.setValue(a.x,a.y,a.width,a.height),e.setViewPort(t.Viewport.TEMP),e.setScissor(t.Vector4.TEMP),e.setClearData(t.RenderClearFlag.Color|t.RenderClearFlag.Depth,this._defaultNormalDepthColor,1,0),e.setRenderTarget(this.depthNormalTarget,t.RenderClearFlag.Color|t.RenderClearFlag.Depth),this._opaqueList.renderQueue(e),t.LayaGL.statAgent.recordCTData(t.StatElement.CT_DepthCastDrawCall,this._opaqueList.elements.length),t.Camera.depthPass._setupDepthModeShaderValue(t.DepthTextureMode.DepthNormals,this.camera)}_mainPass(e){e.pipelineMode=this.pipelineMode,r.renderCmd(this.beforeForwardCmds,e),r.recoverRenderContext3D(e,this.destTarget),e.setClearData(this.clearFlag,this.clearColor,1,0);var a=performance.now();if(this._opaqueList.renderQueue(e),t.LayaGL.statAgent.recordTimeData(t.StatElement.T_3DMainPass_Opaque,performance.now()-a),r.renderCmd(this.beforeSkyboxCmds,e),this.skyRenderNode){const t=this.skyRenderNode.renderelements[0];t.subShader&&e.drawRenderElementOne(t)}this.enableOpaque&&this._opaqueTexturePass(),r.renderCmd(this.beforeTransparentCmds,e),r.recoverRenderContext3D(e,this.destTarget),a=performance.now(),this._transparent.renderQueue(e),t.LayaGL.statAgent.recordTimeData(t.StatElement.T_3DMainPass_Trans,performance.now()-a)}_opaqueTexturePass(){}},e.RenderCullUtil=a,e.RenderListQueue=i,e.RenderPassUtil=r,e.RenderQuickSort=s,e.Web3DRenderModuleFactory=C,e.WebBaseRenderNode=n,e.WebCameraNodeData=c,e.WebDirectLight=o,e.WebGL3DRenderPassFactory=k,e.WebGLBlitQuadCMDData=F,e.WebGLDirectLightShadowRP=E,e.WebGLDrawElementCMDData=O,e.WebGLDrawNodeCMDData=B,e.WebGLForwardAddClusterRP=L,e.WebGLForwardAddRP=x,e.WebGLInstanceRenderBatch=R,e.WebGLInstanceRenderElement3D=T,e.WebGLRender3DProcess=V,e.WebGLRenderContext3D=b,e.WebGLRenderElement3D=P,e.WebGLSetRenderTargetCMD=G,e.WebGLSetViewportCMD=v,e.WebGLSkinRenderElement3D=U,e.WebGLSpotLightShadowRP=I,e.WebLightmap=h,e.WebMeshRenderNode=l,e.WebPointLight=u,e.WebReflectionProbe=p,e.WebSceneNodeData=_,e.WebSceneRenderManager=M,e.WebSimpleSkinRenderNode=g,e.WebSkinRenderNode=m,e.WebSpotLight=S,e.WebVolumetricGI=f}(window.Laya=window.Laya||{},Laya);