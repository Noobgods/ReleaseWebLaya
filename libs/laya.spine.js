!function(e,t){"use strict";class n{constructor(){this.normal=!1}get source(){return this._source}set source(e){this._source=e,e?t.ILaya.loader.load(e,t.Loader.SPINE).then(e=>{!this._source||e&&!e.isCreateFromURL(this._source)||(this.templet=e)}):this.templet=null}get items(){return this._items}set items(e){this._items=e}get templet(){return this._templet}set templet(e){this.init(e)}init(e){this._templet=e,this._templet&&this.flush()}flush(){var e,t,n;let r=null===(e=this.target)||void 0===e?void 0:e.templet,i=null===(t=this._templet)||void 0===t?void 0:t.skeletonData;if(this._items&&i&&r&&r._textures){for(let e=this._items.length-1;e>=0;e--){let t=this._items[e],s=t.attachment,a=t.slot,o=t.skin;if(s&&a&&o){let e=null,t=i.skins;for(let r=t.length-1;r>=0;r--)if(t[r].name==o){let i=t[r].attachments;for(let t=i.length-1;t>=0&&(e=null===(n=i[t])||void 0===n?void 0:n[s],!e);t--);break}if(e){let t=e.region.page;r.setTexture(t.name,t.texture.realTexture);let n=this.target.getSkeleton().findSlot(a);n&&n.setAttachment(e)}}}this.normal=this._templet!==r}else this.normal=!1}}class r{get skin(){return this._skin}set skin(e){this._skin=e}get slot(){return this._slot}set slot(e){this._slot=e}get attachment(){return this._attachment}set attachment(e){this._attachment=e}}class i{static createMesh(e,n,r,i=!1,s=!0){let a=new t.Mesh2D,o=[],h=i?t.BufferUsage.Dynamic:t.BufferUsage.Static,l=t.LayaGL.renderDeviceFactory.createVertexBuffer(h),d=n.vertexDeclaration,u=d.vertexStride;l.vertexDeclaration=d;let p=n.maxVertexCount*u,m=n.vbLength*Float32Array.BYTES_PER_ELEMENT;l.setDataLength(p),s&&l.setData(n.vb.buffer,0,0,m),o.push(l),a._vertexCount=p/u,a._vertexBuffers=o;let c=r.maxIndexCount*r.size;r.ibLength;let f=t.LayaGL.renderDeviceFactory.createIndexBuffer(h);f.indexType=r.type,f.indexCount=r.maxIndexCount,f._setIndexDataLength(c),s&&f._setIndexData(r.ib,0),a._indexBuffer=f;let _=a._bufferState;_.applyState(o,f);let g=[],x=r.outRenderData;for(let e=0,n=x.renderData.length;e<n;e++){let n=x.renderData[e],i=t.LayaGL.renderDeviceFactory.createRenderGeometryElement(t.MeshTopology.Triangles,t.DrawType.DrawElement);i.bufferState=_,i.setDrawElemenParams(n.length,n.offset*r.size),i.indexFormat=r.type,g.push(i)}a._setSubMeshes(g);var y=p+c;return a._setCPUMemory(y),a._setGPUMemory(y),a}static createMeshDynamic(e){let n=new t.Mesh2D,r=[],i=t.BufferUsage.Dynamic,s=t.LayaGL.renderDeviceFactory.createVertexBuffer(i);s.vertexDeclaration=e,r.push(s),n._vertexBuffers=r;let a=t.LayaGL.renderDeviceFactory.createIndexBuffer(i);return n._indexBuffer=a,n._bufferState.applyState(r,a),n}static _updateSpineSubMesh(e,n){let r=e.subMeshCount,i=n.mulitRenderData;if(!i)return!1;let s=i.renderData,a=s.length,o=r!=a,h=e._subMeshes;if(o){let i=Math.max(a,r),o=e._bufferState;for(let e=0;e<i;e++){let r=h[e],i=s[e];i?(r||(r=t.LayaGL.renderDeviceFactory.createRenderGeometryElement(t.MeshTopology.Triangles,t.DrawType.DrawElement),r.bufferState=o,h[e]=r),r.indexFormat=n.type,r.clearRenderParams(),r.setDrawElemenParams(i.length,i.offset*n.size)):r.destroy()}h.length=a}else for(let e=0;e<r;e++){let t=h[e],r=s[e];t.indexFormat=n.type,t.clearRenderParams(),t.setDrawElemenParams(r.length,r.offset*n.size)}return o}static getVertexDeclaration(e){var n=i._vertexDeclarationMap[e];if(!n){for(var r=e.split(","),s=[],a=0,o=0,h=r.length;o<h;o++){var l;switch(r[o]){case"COLOR2":l=new t.VertexElement(a,t.VertexElementFormat.Vector4,11),a+=16;break;case"BONE":l=new t.VertexElement(a,t.VertexElementFormat.Single,3),s.push(l),a+=4,l=new t.VertexElement(a,t.VertexElementFormat.Single,4),s.push(l),a+=4,l=new t.VertexElement(a,t.VertexElementFormat.Vector4,5),s.push(l),a+=16,l=new t.VertexElement(a,t.VertexElementFormat.Vector4,6),s.push(l),a+=16,l=new t.VertexElement(a,t.VertexElementFormat.Vector4,7),a+=16;break;case"RIGIDBODY":l=new t.VertexElement(a,t.VertexElementFormat.Single,4),a+=4;break;case"UV":l=new t.VertexElement(a,t.VertexElementFormat.Vector2,0),a+=8;break;case"COLOR":l=new t.VertexElement(a,t.VertexElementFormat.Vector4,1),a+=16;break;case"POSITION":l=new t.VertexElement(a,t.VertexElementFormat.Vector2,2),a+=8;break;default:throw new Error("unknown vertex flag.")}s.push(l)}n=new t.VertexDeclaration(a,s),i._vertexDeclarationMap[e]=n}return n}static getIndexFormat(e){let n=t.IndexFormat.UInt32;return e<256&&t.LayaGL.renderEngine.getCapable(t.RenderCapable.Element_Index_Uint8)?n=t.IndexFormat.UInt8:e<65536&&(n=t.IndexFormat.UInt16),n}}i._vertexDeclarationMap={};class s{static SetSpineBlendMode(e,n,r=!0){switch(e){case 1:n.blend=t.RenderState.BLEND_ENABLE_ALL,n.blendSrc=t.RenderState.BLENDPARAM_SRC_ALPHA,n.blendDst=t.RenderState.BLENDPARAM_ONE;break;case 3:n.blend=t.RenderState.BLEND_ENABLE_SEPERATE,n.blendSrcRGB=t.RenderState.BLENDPARAM_ONE,n.blendSrcAlpha=t.RenderState.BLENDPARAM_ONE,n.blendDstRGB=t.RenderState.BLENDPARAM_ONE_MINUS_SRC_COLOR,n.blendDstAlpha=t.RenderState.BLENDPARAM_ONE;break;case 2:n.blend=t.RenderState.BLEND_ENABLE_ALL,n.blendSrc=t.RenderState.BLENDPARAM_DST_COLOR,n.blendDst=t.RenderState.BLENDPARAM_ONE_MINUS_SRC_ALPHA;break;default:n.blend=t.RenderState.BLEND_ENABLE_ALL,n.blendSrc=r?t.RenderState.BLENDPARAM_ONE:t.RenderState.BLENDPARAM_SRC_ALPHA,n.blendDst=t.RenderState.BLENDPARAM_ONE_MINUS_SRC_ALPHA}}static initSpineMaterial(e){e.alphaTest=!1,e.depthWrite=!1,e.cull=t.RenderState.CULL_NONE,e.blend=t.RenderState.BLEND_ENABLE_ALL,e.blendSrc=t.RenderState.BLENDPARAM_SRC_ALPHA,e.blendDst=t.RenderState.BLENDPARAM_ONE_MINUS_SRC_ALPHA,e.depthTest=t.RenderState.DEPTHTEST_OFF}static changeVertexDefine(e,t){let n=!1,r=t.vertexBuffers;for(let e=0;e<r.length;e++){if(r[e].vertexDeclaration.getVertexElementByUsage(11)){n=!0;break}}n?e.addDefine(s.SPINE_COLOR2):e.removeDefine(s.SPINE_COLOR2)}static init(){t.Shader3D.addInclude("SpineVertex.glsl","#if !defined(SpineVertex_lib)\n#define SpineVertex_lib\nvoid transfrom(vec2 pos,vec4 xDir,vec4 yDir,out vec2 outPos){outPos.x=xDir.x*pos.x+xDir.y*pos.y+xDir.z;outPos.y=yDir.x*pos.x+yDir.y*pos.y+yDir.z;}void transfrom_spine(vec2 pos,vec3 xDir,vec3 yDir,out vec2 outPos){outPos.x=xDir.x*pos.x-yDir.x*pos.y+xDir.z;outPos.y=xDir.y*pos.x-yDir.y*pos.y+yDir.z;}\n#ifdef SPINE_SIMPLE\nuniform vec4 u_SimpleAnimatorParams;uniform sampler2D u_SimpleAnimatorTexture;uniform float u_SimpleAnimatorTextureSize;vec4 getBonePosBake(float FramePos,float boneIndices,float weight,vec2 pos,float offset){vec2 uv=vec2(0.0,0.0);float PixelPos=FramePos+boneIndices*2.0;float halfOffset=offset*0.5;float uvoffset=PixelPos/u_SimpleAnimatorTextureSize;uv.y=floor(uvoffset)*offset+halfOffset;uv.x=mod(PixelPos,u_SimpleAnimatorTextureSize)*offset+halfOffset;vec4 up=texture2D(u_SimpleAnimatorTexture,uv);uv.x+=offset;vec4 down=texture2D(u_SimpleAnimatorTexture,uv);vec2 outPos;transfrom(pos,up,down,outPos);outPos=outPos*weight;return vec4(outPos,0.,1.0);}\n#endif\n#if defined(SPINE_FAST) || defined(SPINE_RB)\nuniform vec4 u_sBone[200];vec4 getBonePos(float fboneId,float weight,vec2 pos){int boneId=int(fboneId);vec4 up=u_sBone[boneId*2];vec4 down=u_sBone[boneId*2+1];vec2 outPos;transfrom(pos,up,down,outPos);outPos=outPos*weight;return vec4(outPos,0.,1.0);}\n#endif\nuniform vec4 u_color;vec4 getSpinePos(){\n#ifdef SPINE_SIMPLE\n#ifdef GPU_INSTANCE\nfloat currentPixelPos=a_SimpleTextureParams.x+a_SimpleTextureParams.y;\n#else\nfloat currentPixelPos=u_SimpleAnimatorParams.x+u_SimpleAnimatorParams.y;\n#endif\nfloat offset=1.0/u_SimpleAnimatorTextureSize;return getBonePosBake(currentPixelPos,a_BoneId,a_weight,a_position,offset)+getBonePosBake(currentPixelPos,a_PosWeightBoneID_2.w,a_PosWeightBoneID_2.z,a_PosWeightBoneID_2.xy,offset)+getBonePosBake(currentPixelPos,a_PosWeightBoneID_3.w,a_PosWeightBoneID_3.z,a_PosWeightBoneID_3.xy,offset)+getBonePosBake(currentPixelPos,a_PosWeightBoneID_4.w,a_PosWeightBoneID_4.z,a_PosWeightBoneID_4.xy,offset);\n#else\n#ifdef SPINE_FAST\nreturn getBonePos(a_BoneId,a_weight,a_position)+getBonePos(a_PosWeightBoneID_2.w,a_PosWeightBoneID_2.z,a_PosWeightBoneID_2.xy)+getBonePos(a_PosWeightBoneID_3.w,a_PosWeightBoneID_3.z,a_PosWeightBoneID_3.xy)+getBonePos(a_PosWeightBoneID_4.w,a_PosWeightBoneID_4.z,a_PosWeightBoneID_4.xy);\n#endif\n#ifdef SPINE_RB\nreturn getBonePos(a_BoneId,1.0,a_position);\n#endif\n#endif\nreturn vec4(a_position.x,a_position.y,0.,1.);}void getGlobalPos(vec4 pos,out vec2 globalPos){\n#ifdef GPU_INSTANCE\nvec3 down=a_NMatrix_1;vec3 up=a_NMatrix_0;\n#else\nvec3 down=u_NMatrix_1;vec3 up=u_NMatrix_0;\n#endif\ntransfrom_spine(pos.xy,up,down,globalPos);}vec4 getScreenPos(vec4 pos){vec2 globalPos;\n#ifdef GPU_INSTANCE\nvec3 down=a_NMatrix_1;vec3 up=a_NMatrix_0;\n#else\nvec3 down=u_NMatrix_1;vec3 up=u_NMatrix_0;\n#endif\ntransfrom_spine(pos.xy,up,down,globalPos);clip(globalPos);vec2 viewPos;getViewPos(globalPos,viewPos);vec4 outPos;getProjectPos(viewPos,outPos);return outPos;}void getVertexInfo(vec4 pos,inout vertexInfo info){info.pos=pos.xy;info.color=vec4(1.0);\n#ifdef COLOR\ninfo.color=a_color;\n#endif\ninfo.color*=u_baseRenderColor;\n#ifdef PREMULTIPLYALPHA\ninfo.color.rgb=info.color.rgb*info.color.a;\n#endif\n#ifdef UV\ninfo.uv=a_uv;\n#endif\n#ifdef LIGHT2D_ENABLE\nvec2 global;getGlobalPos(pos,global);info.lightUV.x=(global.x-u_LightAndShadow2DParam.x)/u_LightAndShadow2DParam.z;info.lightUV.y=1.0-(global.y-u_LightAndShadow2DParam.y)/u_LightAndShadow2DParam.w;\n#endif\n}\n#endif\n"),t.Shader3D.addInclude("SpineFragment.glsl",'#if !defined(SpineFragment_lib)\n#define SpineFragment_lib\n#include "Sprite2DFrag.glsl";\nvec4 getColor(){vec4 color=texture2D(u_spineTexture,v_texcoord.xy);\n#ifndef GAMMATEXTURE\n#ifdef GAMMASPACE\ncolor.xyz=linearToGamma(color.xyz);\n#endif\n#else\n#ifndef GAMMASPACE\ncolor.xyz=gammaToLinear(color.xyz);\n#endif\n#endif\nvec4 final;\n#ifdef TWOCOLORTINT\nfinal.a=color.a*v_color.a;final.xyz=((color.a-1.0)*v_color2.a+1.0-color.xyz)*v_color2.xyz+color.xyz*v_color.xyz;\n#else\nfinal=color*v_color;\n#endif\nreturn final;}\n#endif\n'),s.BONEMAT=t.Shader3D.propertyNameToID("u_sBone"),s.SpineTexture=t.Shader3D.propertyNameToID("u_spineTexture"),s.SPINE_FAST=t.Shader3D.getDefineByName("SPINE_FAST"),s.SPINE_RB=t.Shader3D.getDefineByName("SPINE_RB"),s.SPINE_UV=t.Shader3D.getDefineByName("UV"),s.SPINE_COLOR=t.Shader3D.getDefineByName("COLOR"),s.SPINE_PREMULTIPLYALPHA=t.Shader3D.getDefineByName("PREMULTIPLYALPHA"),s.SIMPLE_SIMPLEANIMATORPARAMS=t.Shader3D.propertyNameToID("u_SimpleAnimatorParams"),s.SIMPLE_SIMPLEANIMATORTEXTURE=t.Shader3D.propertyNameToID("u_SimpleAnimatorTexture"),s.SIMPLE_SIMPLEANIMATORTEXTURESIZE=t.Shader3D.propertyNameToID("u_SimpleAnimatorTextureSize"),s.SPINE_SIMPLE=t.Shader3D.getDefineByName("SPINE_SIMPLE"),s.SPINE_GPU_INSTANCE=t.Shader3D.getDefineByName("GPU_INSTANCE"),s.SPINE_TWOCOLORTINT=t.Shader3D.getDefineByName("TWOCOLORTINT"),s.SPINE_COLOR2=t.Shader3D.getDefineByName("COLOR2");const e=t.LayaGL.renderDeviceFactory.createGlobalUniformMap("Spine2D");e.addShaderUniformArray(s.BONEMAT,"u_sBone",t.ShaderDataType.Vector4,200),e.addShaderUniform(s.SIMPLE_SIMPLEANIMATORPARAMS,"u_SimpleAnimatorParams",t.ShaderDataType.Vector4),e.addShaderUniform(s.SIMPLE_SIMPLEANIMATORTEXTURE,"u_SimpleAnimatorTexture",t.ShaderDataType.Texture2D),e.addShaderUniform(s.SIMPLE_SIMPLEANIMATORTEXTURESIZE,"u_SimpleAnimatorTextureSize",t.ShaderDataType.Float);let n=t.Shader3D.add("SpineStandard",!0,!1);n.shaderType=t.ShaderFeatureType.D2_BaseRenderNode2D;let r={u_spineTexture:t.ShaderDataType.Texture2D},a=new t.SubShader(s.textureSpineAttribute,r);n.addSubShader(a),a.addShaderPass('#define SHADER_NAME SpineStandardVS\n#include "Sprite2DVertex.glsl";\n#include "SpineVertex.glsl";\nvarying vec4 v_color2;void main(){vec4 pos=getSpinePos();vertexInfo info;getVertexInfo(pos,info);v_texcoord=info.uv;v_color=info.color;\n#ifdef COLOR2\nv_color2=a_color2;\n#else\nv_color2=vec4(0.0,0.0,0.0,1.0);\n#endif\n#ifdef PREMULTIPLYALPHA\nv_color2.xyz=v_color2.xyz*v_color.a;\n#endif\n#ifdef LIGHT2D_ENABLE\nlightAndShadow(info);\n#endif\ngl_Position=getScreenPos(pos);}','#define SHADER_NAME SpineStandardFS\nvarying vec4 v_color2;\n#include "SpineFragment.glsl";\nvoid main(){clip();gl_FragColor=getColor();\n#ifdef LIGHT2D_ENABLE\nlightAndShadow(gl_FragColor);\n#endif\n}'),s.SpineNormalVertexDeclaration=i.getVertexDeclaration("UV,COLOR,POSITION,COLOR2"),s.instanceNMatrixDeclaration=new t.VertexDeclaration(24,[new t.VertexElement(0,t.VertexElementFormat.Vector3,8),new t.VertexElement(12,t.VertexElementFormat.Vector3,9)]),s.instanceSimpleAnimatorDeclaration=new t.VertexDeclaration(16,[new t.VertexElement(0,t.VertexElementFormat.Vector4,10)])}}s.textureSpineAttribute={a_uv:[0,t.ShaderDataType.Vector2],a_color:[1,t.ShaderDataType.Vector4],a_position:[2,t.ShaderDataType.Vector2],a_weight:[3,t.ShaderDataType.Float],a_BoneId:[4,t.ShaderDataType.Float],a_PosWeightBoneID_2:[5,t.ShaderDataType.Vector4],a_PosWeightBoneID_3:[6,t.ShaderDataType.Vector4],a_PosWeightBoneID_4:[7,t.ShaderDataType.Vector4],a_NMatrix_0:[8,t.ShaderDataType.Vector3],a_NMatrix_1:[9,t.ShaderDataType.Vector3],a_SimpleTextureParams:[10,t.ShaderDataType.Vector4],a_color2:[11,t.ShaderDataType.Vector4]},t.Laya.addAfterInitCallback(s.init);class a{get material(){return this._material}set material(e){this._material=e,this.element.materialShaderData=this._material._shaderValues,this.element.subShader=this._material._shader.getSubShaderAt(0)}constructor(e){this.verticesLength=0,this.indicesLength=0,this.vertexBufferLength=0,this.indexBufferLength=0,this.init(),this.material=e}init(){let e=t.LayaGL.renderDeviceFactory.createRenderGeometryElement(t.MeshTopology.Triangles,t.DrawType.DrawElement),n=t.LayaGL.renderDeviceFactory.createBufferState();e.bufferState=n;let r=t.LayaGL.renderDeviceFactory.createVertexBuffer(t.BufferUsage.Dynamic),i=t.LayaGL.renderDeviceFactory.createIndexBuffer(t.BufferUsage.Dynamic);r.vertexDeclaration=this.vertexDeclarition,n.applyState([r],i),e.indexFormat=t.IndexFormat.UInt16,this.geo=e,this.vb=r,this.ib=i,this.element=t.LayaGL.render2DRenderPassFactory.createRenderElement2D(),this.element.nodeCommonMap=["BaseRender2D","spine2D"],this.element.canotPool=!0,this.element.geometry=e,this.element.renderStateIsBySprite=!1}get vertexDeclarition(){return s.SpineNormalVertexDeclaration}draw(){let e=this.vb,t=this.ib,n=4*this.verticesLength,r=2*this.indicesLength;if(n<=0||r<=0)return this.geo.clearRenderParams(),void(this.element.geometry=null);n>this.vertexBufferLength&&(e.setDataLength(n),this.vertexBufferLength=n),r>this.indexBufferLength&&(t._setIndexDataLength(r),this.indexBufferLength=r),e.setData(this.vertexArray.buffer,0,this.vertexArray.byteOffset,n),t._setIndexData(new Uint16Array(this.indexArray.buffer,this.indexArray.byteOffset,r/2),0),this.geo.clearRenderParams(),this.geo.setDrawElemenParams(r/2,0),this.element.geometry=this.geo}drawByData(e,t,n,r){this.vertexArray=e,this.indexArray=n,this.verticesLength=t,this.indicesLength=r,this.draw()}clear(){this.verticesLength=0,this.indicesLength=0}destroy(){this.clear(),this.vb.destroy(),this.ib.destroy(),this.geo.destroy(),this.element.destroy()}_cloneTo(e){e.verticesLength=this.verticesLength,e.indicesLength=this.indicesLength,e.vertexArray=new Float32Array(this.vertexArray),e.indexArray=new Uint16Array(this.indexArray)}}a.maxVertex=10922;class o extends a{constructor(e){super(e),null==o.vertexArray&&(o.vertexArray=new Float32Array(a.maxVertex*o.vertexSize_TwoColor),o.indexArray=new Uint16Array(3*a.maxVertex)),this.vertexArray=o.vertexArray,this.indexArray=o.indexArray}appendVerticesClip(e,t,n=0,r=0){let i=t.length,s=e.length,a=o.vertexSize_TwoColor,h=this.vertexArray,l=this.verticesLength,d=l/a,u=l;for(let t=0;t<s;u+=a,t+=a)h[u]=e[t+6],h[u+1]=e[t+7],h[u+2]=e[t+2],h[u+3]=e[t+3],h[u+4]=e[t+4],h[u+5]=e[t+5],h[u+6]=e[t]+n,h[u+7]=e[t+1]+r,h[u+8]=e[t+8],h[u+9]=e[t+9],h[u+10]=e[t+10],h[u+11]=e[t+11];this.verticesLength=l+s;let p=this.indexArray;for(let e=this.indicesLength,n=0;n<i;e++,n++)p[e]=t[n]+d;this.indicesLength+=i}canAppend(e,t){return this.verticesLength+e<o.maxVertex*o.vertexSize_TwoColor&&this.indicesLength+t<3*o.maxVertex}appendVertices(e,t,n,r,i,s,a,h=0,l=0){let d=o.vertexSize_TwoColor,u=this.verticesLength/d,p=this.vertexArray,m=this.verticesLength;for(let n=0,r=0,o=t;r<o;r+=d,n+=2){let t=m+r;p[t]=a[n],p[t+1]=a[n+1],p[t+2]=i.r,p[t+3]=i.g,p[t+4]=i.b,p[t+5]=i.a,p[t+6]=e[r]+h,p[t+7]=e[r+1]+l,p[t+8]=s.r,p[t+9]=s.g,p[t+10]=s.b,p[t+11]=s.a}this.verticesLength=m+t;let c=this.indexArray;for(let e=this.indicesLength,t=0;t<r;e++,t++)c[e]=n[t]+u;this.indicesLength+=r}}o.vertexSize=8,o.vertexSize_TwoColor=12;class h{constructor(){this.vmeshs=[],this.nextBatchIndex=0}clearBatch(){for(var e=0;e<this.vmeshs.length;e++)this.vmeshs[e].clear();this.nextBatchIndex=0}nextBatch(e,t){if(this.vmeshs.length==this.nextBatchIndex){let n=this.createMesh(e);return this.vmeshs.push(n),t._renderElements[this.nextBatchIndex++]=n.element,n.element.value2DShaderData=t._spriteShaderData,n.element.owner=t.owner._struct,n}let n=this.vmeshs[this.nextBatchIndex];return t._renderElements[this.nextBatchIndex++]=n.element,n.element.owner=t.owner._struct,n.material=e,n}destroy(){for(var e=0;e<this.vmeshs.length;e++)this.vmeshs[e].destroy();this.vmeshs.length=0}}const l=[0,1,2,2,3,0];class d extends h{createMesh(e){return new o(e)}constructor(e){super(),this.templet=e,null==d.vertices&&(d.vertices=spine.Utils.newFloatArray(12288)),this.renderable={vertices:null,numVertices:0,numFloats:0},this.clipper=new spine.SkeletonClipping,this.tempColor=new spine.Color,this.tempColor2=new spine.Color}draw(e,t,n,r){let i=this.clipper;this.clearBatch();let s,a,h,u,p,m=null,c=this.renderable,f=e.drawOrder,_=e.color,g=o.vertexSize_TwoColor,x=!1;-1==n&&(x=!0);let y=d.vertices,S=-e.x+this.templet.offsetX,A=-e.y+this.templet.offsetY,D=t.premultipliedAlpha;for(let e=0,o=f.length;e<o;e++){let o=i.isClipping()?2:g,d=f[e],v=this.templet.needSlot?d:d.bone;if(!d.bone.active){i.clipEndWithSlot(d);continue}if(n>=0&&n==d.data.index&&(x=!0),!x){i.clipEndWithSlot(d);continue}r>=0&&r==d.data.index&&(x=!1);let P,I=d.getAttachment();if(I instanceof window.spine.RegionAttachment){let e=I;c.vertices=y,c.numVertices=4,c.numFloats=o<<2,null!=I.sequence&&I.sequence.apply(d,I),e.computeWorldVertices(v,c.vertices,0,o),a=l,s=e.uvs,P=e.region.page.texture,h=e.color}else{if(!(I instanceof window.spine.MeshAttachment)){if(I instanceof window.spine.ClippingAttachment){let e=I;i.clipStart(d,e);continue}i.clipEndWithSlot(d);continue}{let e=I;c.vertices=y,c.numVertices=e.worldVerticesLength>>1,c.numFloats=c.numVertices*o,c.numFloats>c.vertices.length&&(c.vertices=y=window.spine.Utils.newFloatArray(c.numFloats)),e.computeWorldVertices(d,0,e.worldVerticesLength,c.vertices,0,o),a=e.triangles,P=e.region.page.texture,s=e.uvs,h=e.color}}if(P){let e=d.color,n=this.tempColor;n.r=_.r*e.r*h.r,n.g=_.g*e.g*h.g,n.b=_.b*e.b*h.b,n.a=_.a*e.a*h.a;let r=this.tempColor2;d.darkColor?r.setFromColor(d.darkColor):r.set(0,0,0,1);let o=d.data.blendMode,l=!1;if(o!=m&&(m=o,l=!0),p!=P&&(p=P,l=!0),l){u&&u.draw();let e=t.templet.getMaterial(P.realTexture,m,D);u=this.nextBatch(e,t),u.clear()}i.isClipping()?(i.clipTriangles(c.vertices,c.numFloats,a,a.length,s,n,r,true),u.canAppend(i.clippedVertices.length,i.clippedTriangles.length)||(u.draw(),u=this.nextBatch(u.material,t),u.clear()),u.appendVerticesClip(i.clippedVertices,i.clippedTriangles,S,A)):(u.canAppend(c.numFloats,a.length)||(u.draw(),u=this.nextBatch(u.material,t),u.clear()),0!=n.a&&u.appendVertices(c.vertices,c.numFloats,a,a.length,n,r,s,S,A))}i.clipEndWithSlot(d)}i.clipEnd(),u&&u.draw()}}class u{constructor(){}apply(e,t,n){return e>=this.startFrame&&(!(this._lastFrame>=this.endFrame&&e>=this.endFrame)&&(this._lastFrame=e,this.updateVB(t,n)))}initChange(e){return this.sizeMap=e.slotVBMap.get(this.slotId),!0}updateVB(e,t){if(!this.sizeMap&&(this.sizeMap=e.slotVBMap.get(this.slotId),!this.sizeMap))return!1;let n=t[this.slotId];if(n.attachment){let t=n.deform;if(!t||!t.length)return!1;let r=e.vertexSize,i=this.sizeMap.get(n.attachment.name),s=i.offset*r,a=e.vb,o=i.attachment;e.appendDeform(o,t,s,a)}return!0}clone(){let e=new u;return e.slotId=this.slotId,e.startFrame=this.startFrame,e.endFrame=this.endFrame,e}}class p{changeOrder(e){return this.order}change(e,t){return!0}}class m{constructor(e){this.slotId=e}apply(e,t,n){return this.updateVB(t,n),e>=this.startFrame}initChange(e){return this.sizeMap=e.slotVBMap.get(this.slotId),!0}updateVB(e,t){if(!this.sizeMap&&(this.sizeMap=e.slotVBMap.get(this.slotId),!this.sizeMap))return!1;let n=t[this.slotId],r=n.color;if(n.attachment){let t,i,s,a,o=e.vertexSize,h=this.sizeMap.get(n.attachment.name),l=e.vb,d=h.offset*o,u=h.attachment,p=u.lightColor,m=e.twoColorTint,c=e.vertexDeclaration.getVertexElementByUsage(1).offset/4,f=0;if(m){f=e.vertexDeclaration.getVertexElementByUsage(11).offset/4}p?(t=r.r*p.r,i=r.g*p.g,s=r.b*p.b,a=r.a*p.a):(t=r.r,i=r.g,s=r.b,a=r.a);let _=n.darkColor,g=0,x=0,y=0,S=1;_&&(g=_.r,x=_.g,y=_.b,S=_.a);let A=u.vertexCount;for(let e=0;e<A;e++){let n=d+e*o+c;if(l[n]=t,l[n+1]=i,l[n+2]=s,l[n+3]=a,m){let t=d+e*o+f;l[t]=g,l[t+1]=x,l[t+2]=y,l[t+3]=S}}}return!0}clone(){let e=new m(this.slotId);return e.startFrame=this.startFrame,e.endFrame=this.endFrame,e}}class c{change(e,t){let n=t.get(this.slotId),r=n.get(this.attachment);return r?e.appendVB(r):r=n.get(null),this.attachmentParse=r,!this.attachmentParse.isClip}changeOrder(e){return e[this.slotId]=this.attachmentParse,null}}const f=1/30;class _{static getFloat32Array(e){let t=new Float32Array(8);return t[0]=e.a,t[1]=e.b,t[2]=e.worldX,t[3]=0,t[4]=e.c,t[5]=e.d,t[6]=e.worldY,t[7]=0,t}constructor(){this.isDynamic=!1,this.changeMap=new Map,this.frames=[],this.skinDataArray=[],this.boneFrames=[],this.eventsFrames=[]}getFrameIndex(e,t){let n=this.frames,r=n.length;for(let t=1;t<r;t++)if(n[t]>e)return t-1;return r-1}cacheBones(e){let t=e._play(this.name),n=Math.round(t/f)||1;for(let t=0;t<=n;t++){let n=e._updateState(0==t?0:f),r=[];this.boneFrames.push(r);for(let e=0;e<n.length;e++){let t=n[e],i=_.getFloat32Array(t);r.push(i)}}}check(e,t){this.name=e.name;let n=e.timelines,r=this.changeMap,i=this.frames,s=!1;i.push(0),r.set(0,{});for(let e=0,i=n.length;e<i;e++){let i=n[e],a=i.frames;if(i instanceof spine.AttachmentTimeline){let e=i.attachmentNames,t=i.slotIndex;for(let n=0,i=a.length;n<i;n++){let i=a[n],s=new c;s.slotId=t,s.attachment=e[n]||null;let o=r.get(i);o||(-1==this.frames.indexOf(i)&&this.frames.push(i),o={iChanges:[]},r.set(i,o)),(o.iChanges=o.iChanges||[]).push(s)}}else if(i instanceof spine.DrawOrderTimeline){let e=i.drawOrders;for(let t=0,n=a.length;t<n;t++){let n=a[t],i=new p;i.order=e[t];let s=r.get(n);s||(-1==this.frames.indexOf(n)&&this.frames.push(n),s={iChanges:[]},r.set(n,s)),(s.iChanges=s.iChanges||[]).push(i)}}else if(i instanceof(spine.ColorTimeline||spine.RGBATimeline)||spine.TwoColorTimeline&&i instanceof spine.TwoColorTimeline){let e=i.slotIndex;if(5==a.length&&0==a[0]&&0==a[4]){let t=new c;t.slotId=e,t.attachment=null;let n=0,i=r.get(n);i||(-1==this.frames.indexOf(n)&&this.frames.push(n),i={iChanges:[]},r.set(n,i)),(i.iChanges=i.iChanges||[]).push(t)}else{let t=new m(e),n=a[0],i=a[5*((a.length/5|0)-1)];t.startFrame=n,t.endFrame=i;let s=r.get(n);s||(-1==this.frames.indexOf(n)&&this.frames.push(n),s={vChanges:[]},r.set(n,s)),-1==this.frames.indexOf(i)&&this.frames.push(i),(s.vChanges=s.vChanges||[]).push(t)}}else if(i instanceof window.spine.ClippingAttachment)s=!0;else if(i instanceof window.spine.EventTimeline){if(t.canCache){let e=i.events;for(let t=0,n=a.length;t<n;t++){let n=a[t],r=e[t];(this.eventsFrames[Math.round(n/f)]=this.eventsFrames[n]||[]).push(r)}}}else if(i instanceof spine.DeformTimeline){let e=i.slotIndex,t=new u;t.slotId=e;let n=a[0],s=a[a.length-1];t.startFrame=n,t.endFrame=s;let o=r.get(n);o||(-1==this.frames.indexOf(n)&&this.frames.push(n),o={vChanges:[]},r.set(n,o)),-1==this.frames.indexOf(s)&&this.frames.push(s),(o.vChanges=o.vChanges||[]).push(t)}}this.isDynamic=!!r.size,i.sort(),s||t.canCache&&(this.cacheBones(t),this.isCache=!0),this.frameNumber=i.length}createSkinData(e,t,n,r,i,s){let a=new g;a.type=s;let o=this.frames;return a.init(this.changeMap,e,t,n,o,r,i,this.isDynamic),a.updateBoneMat=this.isCache?0==this.eventsFrames.length?a.updateBoneMatCache:a.updateBoneMatCacheEvent:a.updateBoneMatByBone,this.skinDataArray.push(a),a}destroy(){for(let e=0,t=this.skinDataArray.length;e<t;e++)this.skinDataArray[e].destroy();this.skinDataArray.length=0,this.frames.length=0,this.changeMap.clear()}}class g{constructor(){this.maxVertexCount=0,this.maxIndexCount=0,this.isDynamic=!1,this.renderDatas=[]}getMesh(){return this._defaultMesh}getFrameData(e){return this.renderDatas[e]||this._defaultFrameData}updateBoneMatCache(e,t,n,r,i,s=0,a=0){this.vb.updateBoneCache(t.boneFrames,e/f,i,s,a)}updateBoneMatCacheEvent(e,t,n,r,i){let s=e/f;this.vb.updateBoneCache(t.boneFrames,s,i);let a=Math.round(s),o=r.currentTrack,h=o.lastEventFrame;if(h!=a){if((h>a||null==h)&&(h=-1),a-h<=1){let e=t.eventsFrames[a];if(e)for(let t=0,n=e.length;t<n;t++)r.dispatchEvent(null,"event",e[t])}else for(let e=h+1;e<=a;e++){let n=t.eventsFrames[e];if(n)for(let e=0,t=n.length;e<t;e++)r.dispatchEvent(null,"event",n[e])}o.lastEventFrame=a}}updateBoneMatByBone(e,t,n,r,i,s=0,a=0){this.vb.updateBone(n,i,s,a)}init(e,t,n,r,s,a,o,h){if(this.mainIB=n,this.isDynamic=h,this.canInstance=!this.isDynamic,h){this.vb=t.clone(),this.vb.initBoneMat();let i,h,l=o.slice(),d=s.length;for(let t=0;t<d;t++){let o=s[t],d=e.get(o);if(!d){this.renderDatas[t]=h;continue}let u=d.iChanges,p={};if(u){for(let e=0,t=u.length;e<t;e++){let t=u[e];t.change(this.vb,a)||(this.isNormalRender=!0);let n=t.changeOrder(l);n&&(i=n)}r.createIB(l,this.vb,i),p.ib=r.ib.slice(0,r.ibLength),p.mulitRenderData=r.outRenderData,p.type=r.type,p.size=r.size}let m=d.vChanges;if(m){let e=[];for(let n=0,r=m.length;n<r;n++){let r=m[n].clone();r.initChange(this.vb)&&(r.startFrame=t,r.endFrame=s.indexOf(r.endFrame),e.push(r))}p.vChanges=e}this.renderDatas[t]=p,h=p,o||(p.ib||(p.mulitRenderData=n.outRenderData,p.ib=n.ib.slice(0,this.mainIB.ibLength),p.type=n.type,p.size=n.size),this._defaultFrameData=p)}this.maxIndexCount=Math.max(r.maxIndexCount,this.mainIB.maxIndexCount)}else this.vb=t,this._defaultMesh=i.createMesh(this.type,this.vb,n,this.isDynamic),this._defaultMesh.lock=!0,this.maxIndexCount=n.maxIndexCount;this.maxVertexCount=this.vb.maxVertexCount,this._defaultFrameData||(this._defaultFrameData={mulitRenderData:n.outRenderData,ib:n.ib.slice(0,this.mainIB.ibLength),type:n.type,size:n.size})}destroy(){this._defaultMesh&&this._defaultMesh.destroy(),this._defaultMesh=null,this._defaultFrameData=null,this.renderDatas=null}}class x{}x.BONEVERTEX=22,x.RIGIDBODYVERTEX=9;const y=[0,1,2,2,3,0];class S{constructor(){this.vertexCount=0,this.indexCount=0,this.isNormalRender=!1,this.vertexBones=0,this.bones=new Set}init(e,n,r,i,s){this.slotId=r,this.sourceData=e,this.attachment=e.name,this.boneIndex=n;let a=s.color;this.blendMode=s.blendMode;let o,h=this.color=new t.Color,l=s.darkColor;if(e instanceof spine.RegionAttachment){o=e.color;let t=e;this.vertexArray=t.offset,this.stride=2,this.indexArray=y,this.uvs=t.uvs,t.region&&(this.textureName=t.region.page.name),this.vertexBones=1,this.bones.add(n)}else if(e instanceof spine.MeshAttachment){o=e.color;let t=x.BONEVERTEX,r=e;if(this.textureName=r.region.page.name,r.bones&&0!=r.bones.length){i&&i.length,this.stride=t-6;let e=r.uvs.length/2,n=this.vertexArray=new Float32Array(e*this.stride);this.indexArray=r.triangles,this.uvs=r.uvs;let s=r.vertices,a=r.bones,o=0,h=(t-6)/4;this.vertexBones=h;for(let t=0,r=0;t<e;t++){let e=a[o++];e+=o;let i=[],l=t*this.stride,d=0;for(;o<e;o++,r+=3,d++){let e=a[o];i.push([s[r],s[r+1],s[r+2],e]),this.bones.add(e)}i.length>h&&(this.vertexBones=Math.max(this.vertexBones,i.length),i.length=h,this.isNormalRender=!0);for(let e=0;e<h;e++){let t=i[e];t&&(n[l+4*e]=t[0],n[l+4*e+1]=t[1],n[l+4*e+2]=t[2],n[l+4*e+3]=t[3])}}}else i&&i.length>1?this.vertexArray=new Float32Array(i):this.vertexArray=r.vertices,this.stride=2,this.indexArray=r.triangles,this.uvs=r.uvs,this.bones.add(n)}else e instanceof spine.ClippingAttachment?(this.attachment=null,this.isClip=!0):e instanceof spine.PathAttachment?(this.attachment=e.name,this.vertexArray=new Float32Array(e.vertices),this.isPath=!0):this.attachment=null;return this.textureName&&(this.vertexCount=this.vertexArray.length/this.stride,this.indexCount=this.indexArray.length),o&&(this.lightColor=o,h.r=a.r*o.r,h.g=a.g*o.g,h.b=a.b*o.b,h.a=a.a*o.a),this.darkColor=l,!0}}class A{constructor(){this.renderData=[],this.id=A.ID++}addData(e,t,n,r,i){this.currentData={textureName:e,blendMode:t,offset:n,length:r,attachment:i},this.renderData.push(this.currentData)}endData(e){this.currentData.length=e-this.currentData.offset}}A.ID=0;class D{constructor(){this.ibLength=0,this.maxIndexCount=0}updateFormat(e){let t=i.getIndexFormat(e);this.type!==t&&(this.type=t,this._updateBuffer())}setBufferLength(e){e<=this.maxIndexCount||(this.maxIndexCount=e,this._updateBuffer())}_updateBuffer(){let e=this.ib;switch(this.type){case t.IndexFormat.UInt16:this.size=2,this.ib=new Uint16Array(this.maxIndexCount);break;case t.IndexFormat.UInt8:this.size=1,this.ib=new Uint8Array(this.maxIndexCount);break;case t.IndexFormat.UInt32:this.size=4,this.ib=new Uint32Array(this.maxIndexCount)}e&&this.ib.set(e)}createIB(e,t,n){let r,s,a=0,o=t.slotVBMap;n?(r=n,s=function(t){return e[t]}):(r=e,s=function(e){return e});let h,l,d=new A,u=[],p=-1;for(let e=0,t=r.length;e<t;e++){let t=s(r[e]);if(t.attachment&&!t.isPath){let e=!1;h!=t.textureName&&(h=t.textureName,e=!0),l!=t.blendMode&&(l=t.blendMode,e=!0),e&&(d.currentData&&d.endData(a),d.addData(t.textureName,t.blendMode,a,0,t.attachment));let n=o.get(t.slotId).get(t.attachment);t.attachment&&t.indexArray&&(u.push({data:t.indexArray,offset:n.offset,start:a}),a+=t.indexArray.length,p=Math.max(p,a))}}let m=t.maxVertexCount,c=i.getIndexFormat(m),f=!1;c!==this.type&&(this.type=c,f=!0),p>this.maxIndexCount&&(this.maxIndexCount=p,f=!0),f&&this._updateBuffer();let _=this.ib;for(let e=0,t=u.length;e<t;e++){let t=u[e],n=t.offset,r=t.start;for(let e=0,i=t.data.length;e<i;e++)_[r+e]=t.data[e]+n}h&&d.endData(a),this.outRenderData=d,this.ibLength=a}}class v{constructor(e){this.animator=e,this.reset()}set skinIndex(e){this.currentSKin=this.animator.skinDataArray[e]}get name(){return this.animator.name}reset(){this.currentTime=-1,this.currentFrameIndex=-1}renderWithOutMat(e,t,n){let r=this.currentFrameIndex,i=this.animator.getFrameIndex(n,r);t.renderUpdate(this.currentSKin,i,r),this.currentTime=n,this.currentFrameIndex=i}render(e,t,n,r,i,s,a){this.renderWithOutMat(t,n,r),this.currentSKin.updateBoneMat(r,this.animator,e,this.state,i,s,a)}}class P{constructor(e,t){this.currentMaterials=[],this.cacheMaterials=[],this.vChanges=[],this.vertexBones=0,this.owner=e,this.name=t.name,this.hasNormalRender=t.hasNormalRender,this.vertexBones=t.vertexBones,this.skinAttachType=t.type}getMaterialByName(e,t,n){return this.templet.getMaterial(this.templet.getTexture(e),t,n)}renderUpdate(e,t,n){const r=this.owner._nodeOwner;let i=!1;i=e.isDynamic?this.updateDynamicRender(e,t,n,r):this.handleRender(e,t,r,e.getMesh()),i&&r._updateRenderElements()}updateDynamicRender(e,t,n,r){let s=this.owner.getDynamicMesh(e.vb.vertexDeclaration),a=this.vChanges,o=e.getFrameData(t),h=n<0,l=!1;h&&(this._resetVertexBuffset(e),a.length=0);for(let r=n+1;r<=t;r++){let t=e.getFrameData(r).vChanges;if(t)for(const e of t)a.includes(e)||a.push(e)}for(let n=a.length-1;n>=0;n--){a[n].apply(t,e.vb,this.owner._skeleton.slots)?l=!0:a.splice(n,1)}(l||h)&&this.uploadVertexBuffer(e.vb,s),(o.ib||h)&&this.uploadIndexBuffer(o,s);let d=i._updateSpineSubMesh(s,o);return this.handleRender(e,t,r,s,d)}handleRender(e,t,n,r,i=!1){let s=!1,a=e.getFrameData(t).mulitRenderData;if(a){let e=this.cacheMaterials[a.id]||this.createMaterials(a,n);this.currentMaterials!==e&&(n._updateMaterials(e),s=!0,this.currentMaterials=e)}return!n._onMeshChange(r,i)||s}clearCacheMaterials(){this.cacheMaterials.length=0}createMaterials(e,t){let n=e.renderData.map(e=>this.getMaterialByName(e.textureName,e.blendMode,t.premultipliedAlpha));return this.cacheMaterials[e.id]=n,n}uploadIndexBuffer(e,t){let n=e.ib,r=t._indexBuffer;r.indexType=e.type,r.indexCount=n.length,r._setIndexDataLength(n.byteLength),r._setIndexData(n,0)}uploadVertexBuffer(e,t){let n=t.vertexBuffers[0],r=4*e.vbLength;n.setDataLength(e.maxVertexCount*e.vertexSize*4),n.setData(e.vb.buffer,0,0,r)}init(e,t,n){this.templet=t,this.hasNormalRender&&(this._renderer=U.createNormalRender(t))}render(e){}_resetVertexBuffset(e){let t=this.owner._skeleton.slots,n=e.vb.slotVBMap,r=e.renderDatas,i=new Set;r.forEach(e=>{if(e&&e.vChanges)for(const t of e.vChanges)i.add(t.slotId)}),i.forEach(r=>{var i;let s=t[r];if(s&&s.attachment){let t=null===(i=n.get(r))||void 0===i?void 0:i.get(s.attachment.name);t&&e.vb.resetVB(t.attachment)}})}destroy(){this.hasNormalRender&&this._renderer.destroy()}}class I{constructor(e){this._skinIndex=0,this.renderProxyMap=new Map,this._dynamicMap=new Map,this.animatorMap=new Map,this.skinRenderArray=[],this.boneMat=new Float32Array(8*e.maxBoneNumber),e.skinAttachArray.forEach(e=>{this.skinRenderArray.push(new P(this,e))});let t=e.animators;for(let e=0,n=t.length;e<n;e++){let n=t[e];this.animatorMap.set(n.name,new v(n))}this.currentRender=this.skinRenderArray[this._skinIndex]}getSpineColor(){return this.spineColor}destroy(){this.skinRenderArray.forEach(e=>e.destroy()),this._dynamicMap.forEach(e=>e.destroy()),this._dynamicMap.clear(),this._nodeOwner._onMeshChange(null)}initBake(e){if(this.bakeData=e,e){let t=this.renderProxyMap.get(b.RenderBake)||new C(this._nodeOwner);t.simpleAnimatorTexture=e.texture2d,t._bonesNums=e.bonesNums,t.aniOffsetMap=e.aniOffsetMap,this.renderProxyMap.set(b.RenderBake,t)}this.isBake=!!e,this._curAnimationName&&(this._clear(),this.play(this._curAnimationName))}changeSkeleton(e){this._skeleton=e,this.renderProxyMap.forEach(t=>{t.changeSkeleton(e)}),e.showSkinByIndex(this._skinIndex),this._skeleton.setSlotsToSetupPose()}init(e,n,r,i){this._skeleton=e,this._nodeOwner=r;let s=e.color;this.spineColor=new t.Color(s.r,s.g,s.b,s.a),r._getRenderHandle().baseColor=this.spineColor,this.skinRenderArray.forEach(t=>{t.init(e,n,r)}),this._state=i,this.animatorMap.forEach((e,t)=>{e.state=i});let a=new w(this._nodeOwner),o=new E(this._nodeOwner);this.renderProxyMap.set(b.RenderNormal,o),this.renderProxyMap.set(b.RenderOptimize,a)}get renderProxytype(){return this._renderProxytype}set renderProxytype(e){this.isBake&&e==b.RenderOptimize&&null!=this.bakeData.aniOffsetMap[this._curAnimationName]&&(e=b.RenderBake),this.renderProxy=this.renderProxyMap.get(e),e==b.RenderNormal&&(this._nodeOwner._spriteShaderData.removeDefine(s.SPINE_FAST),this._nodeOwner._spriteShaderData.removeDefine(s.SPINE_RB)),this._renderProxytype=e}beginCache(){this._state.apply=this._state.applyCache,this._state.getCurrentPlayTime=this._state.getCurrentPlayTimeByCache,this._skeleton.updateWorldTransform=this._skeleton.updateWorldTransformCache}endCache(){this._state.apply=this._state.oldApply,this._state.getCurrentPlayTime=this._state.getCurrentPlayTimeOld,this._skeleton.updateWorldTransform=this._skeleton.oldUpdateWorldTransform}setSkinIndex(t){switch(this._skinIndex=t,this.currentRender=this.skinRenderArray[t],this.currentRender.skinAttachType){case e.ESpineRenderType.boneGPU:this._nodeOwner._spriteShaderData.addDefine(s.SPINE_FAST),this._nodeOwner._spriteShaderData.removeDefine(s.SPINE_RB);break;case e.ESpineRenderType.rigidBody:this._nodeOwner._spriteShaderData.addDefine(s.SPINE_RB),this._nodeOwner._spriteShaderData.removeDefine(s.SPINE_FAST);break;case e.ESpineRenderType.normal:this._nodeOwner._spriteShaderData.removeDefine(s.SPINE_FAST),this._nodeOwner._spriteShaderData.removeDefine(s.SPINE_RB)}this.currentAnimation&&(this._clear(),this.play(this._curAnimationName))}getDynamicMesh(e,t=!0){let n=e.id,r=this._dynamicMap.get(n);return!r&&t&&(r=i.createMeshDynamic(e),r.lock=!0,this._dynamicMap.set(n,r)),r}_clear(){this._nodeOwner.clearRenderElement(),this._isRender=!1}play(t){this._curAnimationName=t;let n=this.currentRender,r=this.renderProxy,i=this.currentAnimation,a=i?i.currentSKin:null,o=this.currentAnimation=this.animatorMap.get(t);o.skinIndex=this._skinIndex;let h=o.currentSKin;if(i&&i.reset(),h.isNormalRender)this.renderProxytype=b.RenderNormal;else{switch(n.vertexBones>4&&console.warn(`In FastRender mode - Current skin: ${n.name} has ${n.vertexBones} bones influencing each vertex. This exceeds the recommended limit of 4 bones per vertex.`),this.currentRender.skinAttachType){case e.ESpineRenderType.boneGPU:this._nodeOwner._spriteShaderData.addDefine(s.SPINE_FAST),this._nodeOwner._spriteShaderData.removeDefine(s.SPINE_RB);break;case e.ESpineRenderType.rigidBody:this._nodeOwner._spriteShaderData.addDefine(s.SPINE_RB),this._nodeOwner._spriteShaderData.removeDefine(s.SPINE_FAST);break;case e.ESpineRenderType.normal:this._nodeOwner._spriteShaderData.removeDefine(s.SPINE_FAST),this._nodeOwner._spriteShaderData.removeDefine(s.SPINE_RB)}i&&a.isNormalRender&&this._clear(),a==h&&this._nodeOwner._mesh||(this.currentAnimation.currentFrameIndex=-1),this._isRender||(this.renderProxytype=b.RenderOptimize,this._isRender=!0)}r&&r.leave(),this.renderProxy.change(n,o),!o.animator.isCache&&this.renderProxytype!=b.RenderBake||h.isNormalRender?this.endCache():this.beginCache()}clearCacheMaterials(){this.skinRenderArray.forEach(e=>e.clearCacheMaterials())}complete(){this.currentAnimation.currentFrameIndex=-1}render(e){this.renderProxy.render(e,this.boneMat)}}var b,B;!function(e){e[e.RenderNormal=0]="RenderNormal",e[e.RenderOptimize=1]="RenderOptimize",e[e.RenderBake=2]="RenderBake"}(b||(b={}));class w{constructor(e){this._renderNode=e,this._templet=e.templet,this.changeSkeleton(e.getSkeleton())}changeSkeleton(e){this._skeleton=e,this.bones=e.bones,this.slots=e.slots}change(e,t){this.skinUpdate=e,this.currentAnimation=t}leave(){}render(e,t){let n=-this._skeleton.x+this._templet.offsetX,r=-this._skeleton.y+this._templet.offsetY;this.currentAnimation.render(this.bones,this.slots,this.skinUpdate,e,t,n,r),this._renderNode._spriteShaderData.setBuffer(s.BONEMAT,t)}}class E{constructor(e){this._renderNode=e,this.changeSkeleton(e.getSkeleton())}changeSkeleton(e){this._skeleton=e}leave(){this._renderNode._spriteShaderData.removeDefine(s.SPINE_COLOR2)}change(e,t){this._renderer=e._renderer,this._renderNode._spriteShaderData.addDefine(s.SPINE_COLOR2)}render(e,t){this._renderNode.clearRenderElement(),this._renderer.draw(this._skeleton,this._renderNode,-1,-1),this._renderNode.owner._struct.renderElements=this._renderNode._renderElements}}class C{get simpleAnimatorTexture(){return this._simpleAnimatorTexture}set simpleAnimatorTexture(e){this._simpleAnimatorTexture&&this._simpleAnimatorTexture._removeReference(),this._simpleAnimatorTexture=e,this._simpleAnimatorTextureSize=e.width,this._renderNode._spriteShaderData.setTexture(s.SIMPLE_SIMPLEANIMATORTEXTURE,e),e._addReference(),this._renderNode._spriteShaderData.setNumber(s.SIMPLE_SIMPLEANIMATORTEXTURESIZE,this._simpleAnimatorTextureSize)}get simpleAnimatorOffset(){return this._simpleAnimatorOffset}set simpleAnimatorOffset(e){e.cloneTo(this._simpleAnimatorOffset)}constructor(e){this.step=1/60,this._simpleAnimatorParams=new t.Vector4,this._renderNode=e,this._simpleAnimatorOffset=new t.Vector2,this.changeSkeleton(e.getSkeleton())}changeSkeleton(e){this._skeleton=e,this.bones=e.bones,this.slots=e.slots}leave(){this._renderNode._spriteShaderData.removeDefine(s.SPINE_SIMPLE),this._renderNode._renderType=t.BaseRender2DType.spine}change(e,n){this.skinRender=e,this.currentAnimation=n,this._renderNode._spriteShaderData.addDefine(s.SPINE_SIMPLE),this._simpleAnimatorOffset.x=this.aniOffsetMap[n.name],n.currentSKin.canInstance&&(this._renderNode._renderType=t.BaseRender2DType.spineSimple)}_computeAnimatorParamsData(){this._simpleAnimatorParams.x=this._simpleAnimatorOffset.x,this._simpleAnimatorParams.y=Math.round(this._simpleAnimatorOffset.y)*this._bonesNums*2}setCustomData(e,t=0){this._simpleAnimatorParams.z=e,this._simpleAnimatorParams.w=t}render(e,t){this.currentAnimation.renderWithOutMat(this.slots,this.skinRender,e),this._simpleAnimatorOffset.y=e/this.step,this._computeAnimatorParamsData(),this._renderNode._spriteShaderData.setVector(s.SIMPLE_SIMPLEANIMATORPARAMS,this._simpleAnimatorParams)}}class T{constructor(e,t=0,n=!0){this._vertexSize=0,this._baseVtxCount=6,this._boneVtxCount=4,this.twoColorTint=!1,this.boneMaxId=0,this.maxVertexCount=t,this.vertexFlag=e,this.mapIndex=new Map,this.slotVBMap=new Map,this.boneArray=[],this.vbLength=0,n&&(this._vertexDeclaration=i.getVertexDeclaration(this.vertexFlag),this.twoColorTint=-1!=e.indexOf("COLOR2"),this.twoColorTint&&(this._baseVtxCount+=4),this._vertexSize=this._vertexDeclaration.vertexStride/4,this._boneVtxCount=this._vertexSize-this._baseVtxCount,this._updateBuffer())}setBufferLength(e){e<=this.maxVertexCount||(this.maxVertexCount=e,this._updateBuffer())}_updateBuffer(){let e=this.vb;this.vb=new Float32Array(this.maxVertexCount*this.vertexSize),e&&this.vb.set(e)}get vertexSize(){return this._vertexSize}get vertexDeclaration(){return this._vertexDeclaration}appendAndCreateIB(e){this.appendVB(e)}getBoneId(e){let t=this.mapIndex.get(e);return null==t&&(t=this.boneMaxId,this.mapIndex.set(e,t),this.boneArray.push(t,e),this.boneMaxId++),t}initBoneMat(){this.boneMat=new Float32Array(8*this.mapIndex.size)}appendVB(e){let t,n=this.slotVBMap.get(e.slotId);if(n){let t=n.get(e.attachment);if(null!=t)return t}else n=new Map,this.slotVBMap.set(e.slotId,n);return t=this.vbLength/this.vertexSize,n.set(e.attachment,{offset:t,attachment:e}),e.vertexCount?(t+e.vertexCount>=this.maxVertexCount&&this.setBufferLength(t+e.vertexCount),this.vbLength=this.appendVertexArray(e,this.vb,this.vbLength,this),t):t}resetVB(e){var t;if(e.isPath)return;let n=null===(t=this.slotVBMap.get(e.slotId))||void 0===t?void 0:t.get(e.attachment);n&&this.appendVertexArray(e,this.vb,n.offset*this.vertexSize,this)}updateBone(e,t,n=0,r=0){let i=this.boneArray;for(let s=0,a=i.length;s<a;s+=2){let a=8*i[s],o=e[i[s+1]];t[a]=o.a,t[a+1]=o.b,t[a+2]=o.worldX+n,t[a+3]=0,t[a+4]=o.c,t[a+5]=o.d,t[a+6]=o.worldY+r,t[a+7]=0}}updateBoneCache(e,t,n,r=0,i=0){let s,a=this.boneArray,o=Math.floor(t);s=o==e.length-1?0:t-o;let h=e[o],l=e[o+1];if(s>1e-4)for(let e=0,t=a.length;e<t;e+=2){let t=8*a[e],r=h[a[e+1]],i=l[a[e+1]];n[t]=r[0]+(i[0]-r[0])*s,n[t+1]=r[1]+(i[1]-r[1])*s,n[t+2]=r[2]+(i[2]-r[2])*s,n[t+3]=0,n[t+4]=r[4]+(i[4]-r[4])*s,n[t+5]=r[5]+(i[5]-r[5])*s,n[t+6]=r[6]+(i[6]-r[6])*s,n[t+7]=0}else for(let e=0,t=a.length;e<t;e+=2){let t=8*a[e],r=h[a[e+1]];n.set(r,t)}}_cloneTo(e){e.vb=new Float32Array(this.vb),e.vbLength=this.vbLength,e.mapIndex=new Map(this.mapIndex),e.boneMaxId=this.boneMaxId,e.boneArray=this.boneArray.slice(),e._vertexDeclaration=this._vertexDeclaration,e._vertexSize=this._vertexSize,e.twoColorTint=this.twoColorTint,e._baseVtxCount=this._baseVtxCount,e._boneVtxCount=this._boneVtxCount,e.vertexFlag=this.vertexFlag,this.slotVBMap.forEach((t,n)=>{e.slotVBMap.set(n,new Map(t))})}clone(){let e=this._create();return this._cloneTo(e),e}}class R extends T{_create(){return new R(this.vertexFlag,this.maxVertexCount,!1)}appendVertexArray(e,t,n,r){if(!e.attachment)return r.getBoneId(e.boneIndex),n;let i=this.vertexSize,s=e.vertexArray,a=e.uvs,o=e.color,h=o.r,l=o.g,d=o.b,u=o.a,p=this._boneVtxCount/4,m=e.darkColor,c=0,f=0,_=0,g=1;if(m&&(c=m.r,f=m.g,_=m.b,g=m.a),2==e.stride){let o=r.getBoneId(e.boneIndex);for(let r=0,m=s.length;r<m;r+=e.stride){t[n]=a[r],t[n+1]=a[r+1],t[n+2]=h,t[n+3]=l,t[n+4]=d,t[n+5]=u,t[n+6]=s[r],t[n+7]=s[r+1],t[n+8]=1,t[n+9]=o;let e=n+10;for(let n=0,r=p-1;n<r;n++){let r=e+4*n;t[r]=0,t[r+1]=0,t[r+2]=0,t[r+3]=0}if(this.twoColorTint){let e=n+6+this._boneVtxCount;t[e]=c,t[e+1]=f,t[e+2]=_,t[e+3]=g}n+=i}}else for(let o=0,m=0,x=s.length;o<x;o+=e.stride,m+=2){t[n]=a[m],t[n+1]=a[m+1],t[n+2]=h,t[n+3]=l,t[n+4]=d,t[n+5]=u;let e=n+6;for(let n=0;n<p;n++){let i=e+4*n,a=o+4*n;t[i]=s[a],t[i+1]=s[a+1],t[i+2]=s[a+2],t[i+3]=r.getBoneId(s[a+3])}if(this.twoColorTint){let n=e+this._boneVtxCount;t[n]=c,t[n+1]=f,t[n+2]=_,t[n+3]=g}n+=i}return n}appendDeform(e,t,n,r){if(!e.attachment)return;let i=this.vertexSize,s=e.vertexArray;if(2==e.stride)for(let a=0,o=s.length;a<o;a+=e.stride)r[n+6]=t[a],r[n+7]=t[a+1],n+=i;else{let a=e.sourceData.bones,o=e.vertexCount,h=this._boneVtxCount/4,l=0,d=0;for(let e=0;e<o;e++){let o=a[d++],u=e*this._boneVtxCount,p=n+e*i+6;for(let e=0;e<o&&!(e>=h);e++){let n=l+2*e,i=u+4*e,a=p+4*e;r[a]=s[i]+t[n],r[a+1]=s[i+1]+t[n+1]}d+=o,l+=2*o}}}}class M extends T{_create(){return new M(this.vertexFlag,this.maxVertexCount,!1)}appendVertexArray(e,t,n,r){let i=e.vertexArray,s=e.uvs,a=e.color,o=e.darkColor,h=this.vertexSize,l=a.r,d=a.g,u=a.b,p=a.a,m=0,c=0,f=0,_=1;if(o&&(m=o.r,c=o.g,f=o.b,_=o.a),2==e.stride){let a=r.getBoneId(e.boneIndex);for(let r=0,o=i.length;r<o;r+=e.stride){if(t[n+0]=s[r],t[n+1]=s[r+1],t[n+2]=l,t[n+3]=d,t[n+4]=u,t[n+5]=p,t[n+6]=i[r],t[n+7]=i[r+1],t[n+8]=a,this.twoColorTint){let e=n+9;t[e]=m,t[e+1]=c,t[e+2]=f,t[e+3]=_}n+=h}}return n}appendDeform(e,t,n,r){if(!e.attachment)return;let i=this.vertexSize,s=e.vertexArray;if(2==e.stride)for(let a=0,o=s.length;a<o;a+=e.stride)r[n+6]=t[a],r[n+7]=t[a+1],n+=i}}class k{constructor(){this.blendModeMap=new Map,this.skinAttachArray=[],this.animators=[],this.canCache=k.cacheSwitch}_initSpineRender(e,t,n,r){let i;return k.normalRenderSwitch?i=new j:this.maxBoneNumber>k.MAX_BONES?(console.warn("The number of Bones :",this.maxBoneNumber," > ",k.MAX_BONES,", use CPU caculation"),i=new j):i=new I(this),i.init(e,t,n,r),i}_updateState(e){return this._state.update(e),this._state.getCurrent(0),this._state.apply(this.sketon),this.sketon.updateWorldTransform(2),this.sketon.bones}_play(e){let t=this._state.setAnimation(0,e,!0);return t.animationStart=0,t.animation.duration}checkMainAttach(e){this.sketon=new spine.Skeleton(e),this._stateData=new spine.AnimationStateData(this.sketon.data),this._state=new spine.AnimationState(this._stateData),this.attachMentParse(e),this.initAnimation(e.animations)}attachMentParse(e){let t,n=e.skins,r=e.slots;this._tempIbCreate=new D;for(let e=0,i=n.length;e<i;e++){let i=n[e],s=new N;s.name=i.name,s._tempIbCreate=this._tempIbCreate,0!=e&&s.copyFrom(t),s.attachMentParse(i,r),this.skinAttachArray.push(s),s.init(r),0==e&&(t=s)}}initAnimation(e){let t=0;for(let n=0,r=e.length;n<r;n++){let r=e[n],i=new _;i.check(r,this),this.animators.push(i),this.skinAttachArray.forEach(e=>{e.initAnimator(i)}),i.skinDataArray.forEach(e=>{if(!e.isNormalRender){let n=e.vb.boneArray.length/2;n>t&&(t=n)}})}this.maxBoneNumber=t}cacheBone(){if(!k.cacheSwitch)for(let e=0,t=this.animators.length;e<t;e++){let t=this.animators[e];0==t.boneFrames.length&&t.cacheBones(this)}}destroy(){for(let e=0,t=this.animators.length;e<t;e++)this.animators[e].destroy();this.animators.length=0}init(e){}}k.normalRenderSwitch=!1,k.MAX_BONES=100,k.cacheSwitch=!1;class N{constructor(){this.vertexBones=0,this.slotAttachMap=new Map,this.mainAttachMentOrder=[]}copyFrom(e){e.slotAttachMap.forEach((e,t)=>{this.slotAttachMap.set(t,new Map(e))})}attachMentParse(t,n){let r=0,i=t.attachments,s=0,a=0,o=!1,h=new Set;for(let e=0,t=n.length;e<t;e++){let t=i[e],l=n[e],d=l.boneData.index,u=this.slotAttachMap.get(e),p=l.attachmentName;if(u||(u=new Map,this.slotAttachMap.set(e,u)),t)for(let n in t){let i=t[n],p=null,m=new S;m.init(i,d,e,p,l),r=Math.max(r,m.vertexBones),a+=m.indexCount,s+=m.vertexCount,o=o||!!m.darkColor,u.set(n,m),m.bones.forEach(e=>{h.add(e)})}else if(p){let e=u.get(p);e&&(a+=e.indexCount,s+=e.vertexCount,r=Math.max(r,e.vertexBones),o=o||!!e.darkColor,e.bones.forEach(e=>{h.add(e)}))}if(!u.get(null)){let t=new S;t.slotId=e,t.color=l.color,t.boneIndex=d,t.attachment=null,u.set(t.attachment,t)}}let l,d=h.size;switch(this.type=d>1?e.ESpineRenderType.boneGPU:1===d?e.ESpineRenderType.rigidBody:e.ESpineRenderType.normal,this.vertexBones=r,this.type){case e.ESpineRenderType.normal:case e.ESpineRenderType.boneGPU:l="UV,COLOR,POSITION,BONE",o&&(l+=",COLOR2"),this.mainVB=new R(l,s);break;case e.ESpineRenderType.rigidBody:l="UV,COLOR,POSITION,RIGIDBODY",o&&(l+=",COLOR2"),this.mainVB=new M(l,s)}this.mainIB=new D,this.mainIB.updateFormat(s),this.mainIB.setBufferLength(a)}init(e){let t=this.mainAttachMentOrder;e.forEach((e,n)=>{let r=e.attachmentName;if(r){let e=this.slotAttachMap.get(n).get(r);e?this.mainVB.appendVB(e):e=this.slotAttachMap.get(n).get(null),e.isClip&&(this.isNormalRender=!0),t.push(e)}else{let e=this.slotAttachMap.get(n).get(null);t.push(e)}}),this.mainVB.initBoneMat(),this.mainIB.createIB(t,this.mainVB)}initAnimator(e){let t=e.createSkinData(this.mainVB,this.mainIB,this._tempIbCreate,this.slotAttachMap,this.mainAttachMentOrder,this.type);t.name=this.name,this.isNormalRender&&(t.isNormalRender=!0),t.isNormalRender&&(this.hasNormalRender=!0)}}class L{constructor(e){this.realTexture=e}getImage(){var e,t,n,r;return{width:null!==(t=null===(e=this.realTexture)||void 0===e?void 0:e.width)&&void 0!==t?t:16,height:null!==(r=null===(n=this.realTexture)||void 0===n?void 0:n.height)&&void 0!==r?r:16}}setFilters(e,n){if(!this.realTexture)return;let r;r=n===window.spine.TextureFilter.Nearest?t.FilterMode.Point:t.FilterMode.Bilinear,this.realTexture.filterMode=r}convertWrapMode(e){return e==spine.TextureWrap.ClampToEdge?t.WrapMode.Clamp:e==spine.TextureWrap.MirroredRepeat?t.WrapMode.Mirrored:t.WrapMode.Repeat}setWraps(e,t){this.realTexture&&(this.realTexture.wrapModeU=this.convertWrapMode(e),this.realTexture.wrapModeV=this.convertWrapMode(t))}}class O extends t.Resource{constructor(){super(),this.materialMap=new Map,this.offsetX=0,this.offsetY=0,this.hasPhysics=!1,this.mainBlendMode=0,this._premultipliedAlpha=!0,this._registTextures={},this._textures={},this.sketonOptimise=new k}get _mainTexture(){let e,t=0;for(let n in this._textures)if(e=this._textures[n],e&&(t++,t>1))return null;return e}get premultipliedAlpha(){return this._premultipliedAlpha}get basePath(){return this._basePath}getMaterial(e,n,r){e||(console.error("SpineError:cant Find Main Texture"),e=t.Texture2D.whiteTexture);let i=e.id+"_"+n,a=this.materialMap.get(i);return a?0==n&&s.SetSpineBlendMode(n,a,r):(a=new t.Material,a.setShaderName("SpineStandard"),s.initSpineMaterial(a),a.setTextureByIndex(s.SpineTexture,e),1!=e.gammaCorrection?a.addDefine(t.ShaderDefines2D.GAMMATEXTURE):a.removeDefine(t.ShaderDefines2D.GAMMATEXTURE),s.SetSpineBlendMode(n,a,r),r?a.addDefine(s.SPINE_PREMULTIPLYALPHA):a.removeDefine(s.SPINE_PREMULTIPLYALPHA),a._addReference(),this.materialMap.set(i,a)),a}getTexture(e){return this._textures[e]}setTexture(e,t){this._textures[e]=t}registerTexture(e){if(!e)return null;let t=e.bitmap;if(!t)return null;let n=t.url,r=new L(t),i=this._registTextures[n];if(!i){let e=n?n.split("/").pop().split("\\").pop():null;i||(i=new spine.TextureAtlasPage(e||n||"texture")),i.name=e,i.texture=r,i.width=t.width,i.height=t.height,this._registTextures[n]=i;let s=i.name;s&&this.setTexture(s,t)}let s=e.name;if(!s){s=e.url.split("/").pop().split("\\").pop()}let a=null;return a||(a=new spine.TextureAtlasRegion(i,s),a.page=i,a.name=s),a.width=e.width,a.height=e.height,a.originalWidth=e.sourceWidth,a.originalHeight=e.sourceHeight,a.offsetX=e.offsetX,a.offsetY=e.offsetY,e.uv&&e.uv.length>=8?(a.u=e.uv[0],a.v=e.uv[1],a.u2=e.uv[4],a.v2=e.uv[5]):(a.u=0,a.v=0,a.u2=1,a.v2=1),a.texture=r,a}checkPremultipliedAlpha(){let e=!0,t=this._atlas.pages;for(let n=0,r=t.length;n<r;n++){let r=t[n];if(r){let t=r.texture.realTexture;e=r.pma||t._premultiplyAlpha&&e}}return e}_parse(e,t,n,r=!0){var i;let s=new spine.AtlasAttachmentLoader(t);if(e instanceof ArrayBuffer){let t=new spine.SkeletonBinary(s,!1);this.skeletonData=t.readSkeletonData(new Uint8Array(e))}else{let t=new spine.SkeletonJson(s,!1);this.skeletonData=t.readSkeletonData(e)}this._textures=n,this._atlas=t,this.mainBlendMode=(null===(i=this.skeletonData.slots[0])||void 0===i?void 0:i.blendMode)||0,this.mainTexture=this._mainTexture,this._premultipliedAlpha=r,this.hasPhysics=this.skeletonData.physicsConstraints&&this.skeletonData.physicsConstraints.length>0,this.sketonOptimise.canCache=this.sketonOptimise.canCache&&!this.hasPhysics,this.sketonOptimise.checkMainAttach(this.skeletonData);let a=this.sketonOptimise.sketon;if(null==this.skeletonData.x||null==this.skeletonData.y||null==this.skeletonData.width||null==this.skeletonData.height){let e=new spine.Vector2,t=new spine.Vector2;a.setToSetupPose(),a.updateWorldTransform(0),a.getBounds(e,t),this.width=t.x,this.height=t.y,this.offsetX=e.x+t.x,this.offsetY=-(e.y+t.y)}else this.width=this.skeletonData.width||0,this.height=this.skeletonData.height||0,this.offsetX=(this.skeletonData.x||0)+this.width,this.offsetY=-((this.skeletonData.y||0)+this.height)}getAniNameByIndex(e){let t=this.skeletonData.getAnimationByIndex(e);return t?t.name:null}findAnimation(e){return this.skeletonData.findAnimation(e)}getSkinIndexByName(e){return this.skeletonData.getSkinIndexByName(e)}_disposeResource(){this.sketonOptimise.destroy();for(let e in this._textures){let t=this._textures[e];t&&t._removeReference()}this._referenceCount<=0?(this.materialMap.forEach(e=>{e._removeReference()}),this.materialMap.clear()):console.error("SpineTemplet is using"),this.skeletonData=null,this.sketonOptimise=null}}O.RuntimeVersion="3.8";class V extends a{constructor(e){super(e),this._renderElement2D=t.LayaGL.render2DRenderPassFactory.createRenderElement2D(),this._renderElement2D.geometry=this.geo,this._renderElement2D.nodeCommonMap=["BaseRender2D","spine2D"]}destroy(){super.destroy(),this._renderElement2D.destroy()}}class F extends h{constructor(e){super(),this.vmeshs=[],this.nextBatchIndex=0,this.templet=e}createMesh(e){return new V(e)}draw(e,t,n,r){this.nextBatchIndex=0,U.drawSkeleton((e,n,r,i)=>{let s=t.templet.getMaterial(this.templet.getTexture(r),i.value,t.premultipliedAlpha);this.nextBatch(s,t).drawByData(U._vbArray,e,U._ibArray,n),t.owner._struct.renderElements=t._renderElements},e,!0,n,r)}}class U{static initialize(){if(window.Spine)return U.isWasm=!0,window.Spine().then(e=>(U._spine=e,window.spine=e,U.initClass(),U.bindBuffer(131064,32766),U.allAdpat(),Promise.resolve()));window.spine&&(U.isWasm=!1,U.adaptJS(),U.allAdpat())}static createNormalRender(e){return U.isWasm?new F(e):new d(e)}static allAdpat(){let e=window.spine,t=e.AnimationState.prototype;t.oldApply=t.apply,t.applyCache=function(e){},t.getCurrentPlayTimeOld=function(e){return this.getCurrentOld(e).getAnimationTime()},t.getCurrentPlayTime=t.getCurrentPlayTimeOld,t.getCurrentPlayTimeByCache=function(e){let t=this.getCurrent(e),n=t.animationStart,r=t.animationEnd,i=r-n;t.trackLast=t.nextTrackLast;let s=t.trackLast%i,a=t.getAnimationTime(),o=!1;if(o=t.loop?0==i||s>t.trackTime%i:a>=r&&t.animationLast<r,o)return this.dispatchEvent(t,"complete",null),t.nextAnimationLast=-1,t.nextTrackLast=-1,0;t.nextAnimationLast=a,t.nextTrackLast=t.trackTime;let h=t.animationLast;return Math.max(h,0)};let n=e.Skeleton.prototype;n.oldUpdateWorldTransform=n.updateWorldTransform,n.updateWorldTransformCache=function(){},e.AnimationState.prototype.dispatchEvent=function(e,t,n){this.eventsObject[t](e,n)}}static adaptJS(){let e=window.spine;if(e){e.AnimationState.prototype.oldAddListener=e.AnimationState.prototype.addListener,e.AnimationState.prototype.addListener=function(e){this.eventsObject=e,this.oldAddListener(e)};let t=e.SkeletonData.prototype;t.getAnimationsSize=function(){return this.animations.length},t.getAnimationByIndex=function(e){return this.animations[e]},t.getSkinIndexByName=function(e){let t=this.skins;for(let n=0,r=t.length;n<r;n++)if(t[n].name==e)return n;return-1},e.Skeleton.prototype.showSkinByIndex=function(e){this.setSkin(this.data.skins[e])};let n=e.AnimationState.prototype;if(n.getCurrentOld=n.getCurrent,n.getCurrent=function(e){let t=this.getCurrentOld(e);return this.currentTrack=t,t},"3.7"==O.RuntimeVersion){e.Bone.prototype.active=!0}}}static initClass(){let e=window.spine,t=e.AnimationState.prototype;t.addListener=function(e){this.eventsObject=e,this.setListener(U._spine.AnimationStateListenerObject.implement({callback:(t,n,r,i)=>{e[U.stateMap[n.value]](r,i)}}))},t.getCurrentOld=t.getCurrent,t.setAnimationOld=t.setAnimation,t.setAnimation=function(e,t,n){return this.__tracks&&(this.__tracks.length=0),this.setAnimationOld(e,t,n)},t.getCurrent=function(e){let t,n=this.__tracks;return n?t=n[e]:(n=this.__tracks=[],t=this.getCurrentOld(e),n[e]=t),t||(t=this.getCurrentOld(e),n[e]=t),this.currentTrack=t,t},e.TextureAtlas=z,Object.defineProperty(e.Skin.prototype,"attachments",{get:function(){return this.getAttachments()}});let n=e.Skeleton.prototype;Object.defineProperty(n,"slots",{get:function(){return this.getSlots()}}),Object.defineProperty(n,"data",{get:function(){return this.getData()}}),Object.defineProperty(n,"bones",{get:function(){return this.getBones()}}),Object.defineProperty(n,"color",{get:function(){return this.getColor()}});let r=e.SkeletonData.prototype;Object.defineProperty(r,"name",{get:function(){return this.getName()}}),Object.defineProperty(r,"skins",{get:function(){return this.getSkins()}}),Object.defineProperty(r,"slots",{get:function(){return this.getSlots()}});let i=e.Animation.prototype;Object.defineProperty(i,"name",{get:function(){return this.getName()}}),Object.defineProperty(i,"duration",{get:function(){return this.getDuration()}}),Object.defineProperty(i,"timelines",{get:function(){return this.getTimelines()}}),Object.defineProperty(r,"animations",{get:function(){return this.getAnimations()}}),Object.defineProperty(e.Skin.prototype,"name",{get:function(){return this.getName()}});let s=e.SlotData.prototype;Object.defineProperty(s,"boneData",{get:function(){return this.getBoneData()}}),Object.defineProperty(s,"color",{get:function(){return this.getColor()}}),Object.defineProperty(s,"index",{get:function(){return this.getIndex()}}),Object.defineProperty(s,"attachmentName",{get:function(){return this.getAttachmentName()}}),Object.defineProperty(s,"blendMode",{get:function(){return this.getBlendMode().value}}),Object.defineProperty(e.BoneData.prototype,"index",{get:function(){return this.getIndex()}});let a=e.RegionAttachment.prototype;Object.defineProperty(a,"color",{get:function(){return this.getColor()}}),Object.defineProperty(a,"name",{get:function(){return this.getName()}}),Object.defineProperty(a,"offset",{get:function(){return this.getOffset()}}),Object.defineProperty(a,"uvs",{get:function(){return this.getRotateUVs()}}),Object.defineProperty(a,"region",{get:function(){return this}}),Object.defineProperty(a,"page",{get:function(){return this.getPage()}}),Object.defineProperty(e.AtlasPage.prototype,"name",{get:function(){return this.getName()}});let o=e.MeshAttachment.prototype;Object.defineProperty(o,"bones",{get:function(){return this.getBones()}}),Object.defineProperty(o,"uvs",{get:function(){return this.getUVs()}}),Object.defineProperty(o,"triangles",{get:function(){return this.getTriangles()}}),Object.defineProperty(o,"vertices",{get:function(){return this.getVertices()}}),Object.defineProperty(o,"color",{get:function(){return this.getColor()}}),Object.defineProperty(o,"region",{get:function(){return this}}),Object.defineProperty(o,"page",{get:function(){return this.getPage()}}),Object.defineProperty(o,"name",{get:function(){return this.getName()}});let h=e.EventTimeline.prototype;Object.defineProperty(h,"frames",{get:function(){return this.getFrames()}}),Object.defineProperty(h,"events",{get:function(){return this.getEvents()}});let l=e.AttachmentTimeline.prototype;Object.defineProperty(l,"frames",{get:function(){return this.getFrames()}}),Object.defineProperty(l,"slotIndex",{get:function(){return this.getSlotIndex()}}),Object.defineProperty(l,"attachmentNames",{get:function(){return this.getAttachmentNames()}});let d=e.DrawOrderTimeline.prototype;Object.defineProperty(d,"frames",{get:function(){return this.getFrames()}}),Object.defineProperty(d,"drawOrders",{get:function(){return this.getDrawOrders()}});let u=e.ColorTimeline.prototype;Object.defineProperty(u,"frames",{get:function(){return this.getFrames()}}),Object.defineProperty(u,"slotIndex",{get:function(){return this.getSlotIndex()}});let p=e.TrackEntry.prototype;Object.defineProperty(p,"loop",{get:function(){return this.getLoop()}}),Object.defineProperty(p,"animationStart",{get:function(){return this.getAnimationStart()},set:function(e){}}),Object.defineProperty(p,"animationEnd",{get:function(){return this.getAnimationEnd()}}),Object.defineProperty(p,"animationLast",{get:function(){return this.getAnimationLast()}}),Object.defineProperty(p,"nextAnimationLast",{get:function(){return this.getAnimationLast()},set:function(e){this.setNextAnimationLast(e)}}),Object.defineProperty(p,"trackTime",{get:function(){return this.getTrackTime()}}),Object.defineProperty(p,"animation",{get:function(){return this.getAnimation()}});let m=e.Bone.prototype;Object.defineProperty(m,"a",{get:function(){return this.getA()}}),Object.defineProperty(m,"b",{get:function(){return this.getB()}}),Object.defineProperty(m,"c",{get:function(){return this.getC()}}),Object.defineProperty(m,"d",{get:function(){return this.getD()}}),Object.defineProperty(m,"worldX",{get:function(){return this.getWorldX()}}),Object.defineProperty(m,"worldY",{get:function(){return this.getWorldY()}});let c=e.Event.prototype;Object.defineProperty(c,"volume",{get:function(){return this.getVolume()}}),Object.defineProperty(c,"balance",{get:function(){return this.getBalance()}}),Object.defineProperty(c,"time",{get:function(){return this.getTime()}}),Object.defineProperty(c,"data",{get:function(){return this.getData()}}),Object.defineProperty(c,"floatValue",{get:function(){return this.getFloatValue()}}),Object.defineProperty(c,"intValue",{get:function(){return this.getIntValue()}}),Object.defineProperty(c,"stringValue",{get:function(){return this.getStringValue()}});let f=e.EventData.prototype;Object.defineProperty(f,"name",{get:function(){return this.getName()}}),Object.defineProperty(f,"audioPath",{get:function(){return this.getAudioPath()}})}static bindBuffer(e,t){U._spine.createBuffer(e,t),U._vbArray=U._spine.getVertexsBuffer(),U._ibArray=U._spine.getIndexsBuffer()}static drawSkeleton(e,t,n,r,i){U._spine.drawSkeleton(e,t,n,r,i)}}U.stateMap={0:"start",1:"interrupt",2:"end",3:"complete",4:"dispose",5:"event"};class z{constructor(e,t){return new U._spine.Atlas(e,"",U._spine.TextureLoader.implement({load:(e,n)=>{let r=t(n);e.texture=r},unload:function(e){}}),!0)}}t.Laya.addInitCallback(U.initialize);class j{constructor(){this._skinIndex=0}clearCacheMaterials(){}getSpineColor(){return this._spineColor}destroy(){this._renderer.destroy(),this._renderer=null,this._owner._renderElements.length=0}initBake(e){}init(e,n,r,i){this._renderer=U.createNormalRender(n),this._skeleton=e,this._owner=r;let a=e.color;this._spineColor=new t.Color(a.r,a.g,a.b,a.a),r._getRenderHandle().baseColor=this._spineColor,r._spriteShaderData.removeDefine(s.SPINE_FAST),r._spriteShaderData.removeDefine(s.SPINE_RB),r._spriteShaderData.addDefine(s.SPINE_COLOR2)}play(e){}setSkinIndex(e){this._skinIndex=e}changeSkeleton(e){this._skeleton=e,e.showSkinByIndex(this._skinIndex),this._skeleton.setSlotsToSetupPose()}render(e){this._owner.clearRenderElement(),this._renderer.draw(this._skeleton,this._owner,-1,-1),this._owner.owner._struct.renderElements=this._owner._renderElements}complete(){}}class W{clearCacheMaterials(){}getSpineColor(){return t.Color.WHITE}changeSkeleton(e){}init(e,t,n,r){}play(e){}render(e){}setSkinIndex(e){}initBake(e){}destroy(){}complete(){}}W.instance=new W;class G{static checkAttachment(t){if(null==t)return e.ESpineRenderType.rigidBody;if(t instanceof window.spine.RegionAttachment)return e.ESpineRenderType.rigidBody;if(t instanceof window.spine.MeshAttachment){return t.bones?e.ESpineRenderType.boneGPU:e.ESpineRenderType.rigidBody}return e.ESpineRenderType.normal}static appendIndexArray(e,t,n,r){if(!e.attachment||!e.indexArray)return r;let i=e.indexArray;for(let e=0,s=i.length;e<s;e++)t[r]=i[e]+n,r++;return r}static setSlotTexture(e,t,n,r=!1){let i=e.getAttachment();if(!i)return;r&&(i=i.copy(),e.setAttachment(i));let s=n.registerTexture(t);i instanceof spine.RegionAttachment?(i.region=s,i.width=s.width,i.height=s.height,i.updateRegion?i.updateRegion():i.updateOffset&&i.updateOffset()):i instanceof spine.MeshAttachment&&(i.region=s,i.width=s.width,i.height=s.height,i.updateRegion?i.updateRegion():i.updateUVs&&i.updateUVs())}}class X extends t.BaseRenderNode2D{static createRenderElement2D(){let e;return e=this._pool.length>0?this._pool.pop():t.LayaGL.render2DRenderPassFactory.createRenderElement2D(),e.renderStateIsBySprite=!1,e.nodeCommonMap=["spine2D"],e}static recoverRenderElement2D(e){e.canotPool||this._pool.push(e)}constructor(){super(),this.physicsUpdate=2,this._currentPlayTime=0,this._pause=!0,this._needUpdate=!1,this._playbackRate=1,this._playAudio=!0,this._soundChannelArr=[],this.trackIndex=0,this._skinName="default",this._loop=!0,this._offset=new t.Vector2,this._setPreAlphaFlag=!1,this._premultipliedAlpha=!0,this._useFastRender=!0,this._autoAdjust=!1,this._renderElements=[],this._materials=[],this.spineItem=W.instance}_isMaterialVaild(e){return e.checkType(t.ShaderFeatureType.D2_BaseRenderNode2D)}_getcommonUniformMap(){return["BaseRender2D","Spine2D"]}_createRenderHandle(){let e=t.LayaGL.render2DRenderPassFactory.createSpineRenderDataHandle();return e.offset=this._offset,e}get externalSkins(){return this._externalSkins}set externalSkins(e){if(e)for(let t=e.length-1;t>=0;t--)e[t].target=this;this._externalSkins=e}renderUpdate(e){this._updateLight()}resetExternalSkin(){this._skeleton&&(this._skeleton=new spine.Skeleton(this._templet.skeletonData),this.spineItem.changeSkeleton(this._skeleton),this._renderHandle.skeleton=this._skeleton,this._flushExtSkin())}get premultipliedAlpha(){return!this._templet||this._setPreAlphaFlag?this._premultipliedAlpha:this._templet.premultipliedAlpha}set premultipliedAlpha(e){this._premultipliedAlpha=e}setPremultipliedAlpha(e){this.spineItem.clearCacheMaterials(),this._premultipliedAlpha=e,this._setPreAlphaFlag=!0}get source(){return this._source}set source(e){if(this._source=e,e){let n=t.ILaya.loader.getRes(e,t.Loader.SPINE);n?this.templet=n:t.ILaya.loader.load(e,t.Loader.SPINE).then(e=>{!this._source||e&&!e.isCreateFromURL(this._source)||this.destroyed||(this.templet=e)})}else this.templet=null}get skinName(){return this._skinName}set skinName(e){this._skinName=e,this._templet&&this.showSkinByName(e)}get animationName(){return this._animationName}set animationName(e){this._animationName=e,this._templet&&this.play(e,this._loop,!0)}get maxDetlaTime(){return this._timeKeeper.maxDelta}set maxDetlaTime(e){this._timeKeeper.maxDelta=e}get loop(){return this._loop}set loop(e){this._loop=e,this._templet&&this.play(this._animationName,this._loop,!0)}get url(){return this._skin}set url(e){this._skin!=e&&(this._skin=e,t.Laya.loader.load(e,t.Loader.SPINE).then(e=>{this.init(e)}))}get twoColorTint(){return this._spriteShaderData.hasDefine(s.SPINE_TWOCOLORTINT)}set twoColorTint(e){e?this._spriteShaderData.addDefine(s.SPINE_TWOCOLORTINT):this._spriteShaderData.removeDefine(s.SPINE_TWOCOLORTINT)}get templet(){return this._templet}set templet(e){this.init(e)}set currentTime(e){if(this._templet){if((e/=1e3)<this._playStart||this._playEnd&&e>this._playEnd||e>this._duration)throw new Error("AnimationPlayer: value must large than playStartTime,small than playEndTime.");this._state.update(e-this._currentPlayTime),this._currentPlayTime=e}}get playState(){return this._pause?this._currentPlayTime?X.PAUSED:X.STOPPED:X.PLAYING}get useFastRender(){return this._useFastRender}set useFastRender(e){this._useFastRender!==e&&(this._useFastRender=e,this._templet&&(e?this.changeFast():this.changeNormal(),this.play(this._animationName,this._loop,!0,this._currentPlayTime)))}get offset(){return this._offset}set offset(e){this._offset=e,this._renderHandle.offset=this._offset,this.boundsChange=!0,this.playState!==X.PLAYING&&this.owner.repaint(t.RepaintFlag.UpdateRT)}get autoAdjust(){return this._autoAdjust}set autoAdjust(e){this._autoAdjust!==e&&(this._autoAdjust=e,e&&this._doAutoAdjust())}_doAutoAdjust(){var e,t;if(!this._templet)return;let n=this._templet.skeletonData,r=Math.ceil(null!==(e=n.x)&&void 0!==e?e:0),i=Math.ceil(null!==(t=n.y)&&void 0!==t?t:0),s=n.width,a=n.height;if(void 0===s||void 0===a)return console.warn("Spine.SkeletonData: width or height is undefined"),void(this._autoAdjust=!1);s<1&&(s=100),a<1&&(a=100);let o=s+r,h=a+i;this.owner.size(s,a),this.owner.pivot(o,h)}onEnable(){this.owner.on(t.Event.TRANSFORM_CHANGED,this,this.onTransformChanged),this._skeleton&&t.LayaEnv.isPlaying&&void 0!==this._animationName&&this.play(this._animationName,this._loop,!0)}onDisable(){this.owner.off(t.Event.TRANSFORM_CHANGED,this,this.onTransformChanged)}init(e){if(this.destroyed)return;if(this._templet&&this.clear(),this._templet=e,!this._templet)return;if(this._templet._addReference(),this._skeleton=new spine.Skeleton(this._templet.skeletonData),this._renderHandle.skeleton=this._skeleton,this._stateData=new spine.AnimationStateData(this._skeleton.data),this._state=new spine.AnimationState(this._stateData),this._timeKeeper=new H(t.Laya.timer),this.spineItem&&this.spineItem.destroy(),this._struct.renderElements=[],this._struct.setRepaint(),this._autoAdjust&&this._doAutoAdjust(),this.onTransformChanged(),this.boundsChange=!0,this._useFastRender)this.spineItem=this._templet.sketonOptimise._initSpineRender(this._skeleton,this._templet,this,this._state);else{let e=k.normalRenderSwitch;k.normalRenderSwitch=!0,this.spineItem=this._templet.sketonOptimise._initSpineRender(this._skeleton,this._templet,this,this._state),k.normalRenderSwitch=e}let n=this._templet.getSkinIndexByName(this._skinName);-1!=n&&this.showSkinByIndex(n),this._state.addListener({start:e=>{},interrupt:e=>{},end:e=>{},dispose:e=>{},complete:e=>{this.owner.event(t.Event.END),e.loop?(this.spineItem.complete(),this.owner.event(t.Event.COMPLETE)):this.stop()},event:(n,r)=>{let i={audioValue:r.data.audioPath,audioPath:r.data.audioPath,floatValue:r.floatValue,intValue:r.intValue,name:r.data.name,stringValue:r.stringValue,time:1e3*r.time,balance:r.balance,volume:r.volume};if(this.owner.event(t.Event.LABEL,i),this._playAudio&&i.audioValue){let n=t.SoundManager.playSound(e.basePath+i.audioValue,1,t.Handler.create(this,this._onAniSoundStoped),null,(1e3*this._currentPlayTime-i.time)/1e3);t.SoundManager.playbackRate=this._playbackRate,n&&this._soundChannelArr.push(n)}}}),this._flushExtSkin(),this.owner.event(t.Event.READY),t.LayaEnv.isPlaying&&this.enabled&&void 0!==this._animationName&&this.play(this._animationName,this._loop,!0)}play(e,n,r=!0,i=0,s=0,a=!0,o=!0){if(this._playAudio=o,i/=1e3,s/=1e3,this._loop=n,i<0||s<0)throw new Error("SpineSkeleton: start and end must large than zero.");if(0!==s&&i>s)throw new Error("SpineSkeleton: start must less than end.");if("number"==typeof e)e=this.getAniNameByIndex(e);else{if(!!!this.templet.findAnimation(e))return}if(r||this._pause||this._animationName!=e){this._animationName=e,this.spineItem.play(e);let r=this._state.setAnimation(this.trackIndex,e,n);r.animationStart=i,s&&s<r.animationEnd&&(r.animationEnd=s);let a=r.animation.duration;this._duration=a,this._playStart=i,this._playEnd=s<=a?s:a,this._pause&&(this._pause=!1,this._needUpdate=!0),this._update(),this.owner.event(t.Event.PLAYED)}}_update(){this._timeKeeper.update();let e=this._state,n=this._timeKeeper.delta*this._playbackRate;e.update(n);let r=this._currentPlayTime=e.getCurrentPlayTime(this.trackIndex);e.apply(this._skeleton),this._state&&this._skeleton&&!this.destroyed&&(this._skeleton.update&&this._skeleton.update(n),this._skeleton.updateWorldTransform(this.physicsUpdate),this.spineItem.render(r),this.owner.repaint(t.RepaintFlag.UpdateRT))}_flushExtSkin(){if(null==this._skeleton)return;let e=this._externalSkins;if(e){for(let t=e.length-1;t>=0;t--)e[t].flush();this.useFastRender=!1}}getAnimNum(){return this._templet.skeletonData.getAnimationsSize()}getAniNameByIndex(e){return this._templet.getAniNameByIndex(e)}getSlotByName(e){return this._skeleton.findSlot(e)}playbackRate(e){this._playbackRate=e}showSkinByName(e){this.showSkinByIndex(this._templet.getSkinIndexByName(e))}showSkinByIndex(e){this.spineItem.setSkinIndex(e),this._skeleton.showSkinByIndex(e),this._skeleton.setSlotsToSetupPose()}stop(){this._pause||(this._pause=!0,this._needUpdate=!1,this._state.update(-this._currentPlayTime),this._currentPlayTime=0,this.owner.event(t.Event.STOPPED),this._soundChannelArr.length>0&&this._onAniSoundStoped(!0))}onUpdate(){this._needUpdate&&this._update()}paused(){if(!this._pause&&(this._pause=!0,this._needUpdate=!1,this.owner.event(t.Event.PAUSED),this._soundChannelArr.length>0))for(let e=this._soundChannelArr.length,t=0;t<e;t++){let e=this._soundChannelArr[t];e.isStopped||e.pause()}}resume(){if(this._pause&&(this._pause=!1,this._needUpdate=!0,this._soundChannelArr.length>0))for(let e=this._soundChannelArr.length,t=0;t<e;t++){let e=this._soundChannelArr[t];e.audioBuffer&&e.resume()}}_onAniSoundStoped(e){for(let t=this._soundChannelArr.length,n=0;n<t;n++){let r=this._soundChannelArr[n];(r.isStopped||e)&&(!r.isStopped&&r.stop(),this._soundChannelArr.splice(n,1),t--,n--)}}reset(){this._templet._removeReference(1),this._templet=null,this._timeKeeper=null,this._skeleton=null,this._state.clearListeners(),this._state=null,this._pause=!0,this._needUpdate=!1,this._soundChannelArr.length>0&&this._onAniSoundStoped(!0)}addAnimation(e,t=!1,n=0){n/=1e3;let r=e;"number"==typeof r&&(r=this.getAniNameByIndex(r)),this._animationName=r,this._state.addAnimation(this.trackIndex,r,t,n)}setSlotTexture(e,t,n=!0){if(this._useFastRender)return void console.log("setSlotTexture: useFastRender is true, return");if(!this._skeleton)return void console.log("setSlotTexture: skeleton not found, return");let r=this._skeleton.findSlot(e);r?G.setSlotTexture(r,t,this._templet,n):console.log("setSlotTexture: slot not found, slotName: "+e)}setMix(e,t,n){n/=1e3;let r=e;"number"==typeof r&&(r=this.getAniNameByIndex(r));let i=t;"number"==typeof i&&(i=this.getAniNameByIndex(i)),this._stateData.setMix(r,i,n)}getBoneByName(e){return this._skeleton.findBone(e)}getSkeleton(){return this._skeleton}physicsTranslate(e,t){this._templet.hasPhysics&&this._skeleton.physicsTranslate(e,t)}onTransformChanged(){if(this._skeleton){let e=this.owner.globalTrans.getMatrix();this._skeleton.x=e.tx+this._templet.offsetX,this._skeleton.y=e.ty+this._templet.offsetY}}setSlotAttachment(e,t){this.useFastRender=!1,this._skeleton.setAttachment(e,t)}clear(){this.clearRenderElement(),this.reset()}clearRenderElement(){this._mesh=null,this._renderElements.forEach(e=>{X.recoverRenderElement2D(e)}),this._renderElements.length=0}changeFast(){if(!(this.spineItem instanceof I)){this.spineItem.destroy();let e=k.normalRenderSwitch;k.normalRenderSwitch=!1,this.spineItem=this._templet.sketonOptimise._initSpineRender(this._skeleton,this._templet,this,this._state),this.spineItem.setSkinIndex(this._templet.getSkinIndexByName(this._skinName)),k.normalRenderSwitch=e}}changeNormal(){if(!(this.spineItem instanceof j)){this.spineItem.destroy();let e=k.normalRenderSwitch;k.normalRenderSwitch=!0,this.spineItem=this._templet.sketonOptimise._initSpineRender(this._skeleton,this._templet,this,this._state),this.spineItem.setSkinIndex(this._templet.getSkinIndexByName(this._skinName)),k.normalRenderSwitch=e}}onDestroy(){this._templet&&this.clear(),this.spineItem.destroy()}_updateMaterials(e){for(let e=0,t=this._materials.length;e<t;e++)this._materials[e]._removeReference();this._materials.length=0;for(let t=0,n=e.length;t<n;t++)this._materials[t]=e[t],this._materials[t]._addReference()}_updateRenderElements(){let e=this._renderElements.length;for(let t=0;t<e;t++){let e=this._renderElements[t],n=this._materials[t];e.materialShaderData=n.shaderData,e.subShader=n._shader.getSubShaderAt(0),e.value2DShaderData=this.owner._shaderData}this.owner._struct.renderElements=this._renderElements}_onMeshChange(e,t=!1){let n=!1;if(this._mesh!=e||t){if(n=!0,e){let t=e._subMeshes,n=this._renderElements.length,r=Math.max(n,e.subMeshCount);for(let e=0;e<r;e++){let n=this._renderElements[e],r=t[e];if(r){n||(n=X.createRenderElement2D(),this._renderElements[e]=n);let t=this._materials[e];n.geometry=r,n.materialShaderData=t.shaderData,n.subShader=t._shader.getSubShaderAt(0),n.value2DShaderData=this.owner._shaderData,n.nodeCommonMap=this._getcommonUniformMap(),n.owner=this.owner._struct}else X.recoverRenderElement2D(n)}this._renderElements.length=e.subMeshCount,s.changeVertexDefine(this.owner._shaderData,e)}else{for(let e=0,t=this._renderElements.length;e<t;e++)X.recoverRenderElement2D(this._renderElements[e]);this._renderElements.length=0}this.owner._struct&&(this.owner._struct.renderElements=this._renderElements)}return this._mesh=e,n}get rect(){return this._boundsChange&&(this._templet?(this._rect.z=this._templet.width+this._offset.x,this._rect.w=this._templet.height+this._offset.y):(this._rect.z=this.owner.width+this._offset.x,this._rect.w=this.owner.height+this._offset.y),this._rect.x=this._offset.x,this._rect.y=this._offset.y,this._boundsChange=!1),this._rect}}X._pool=[],X.STOPPED=0,X.PAUSED=1,X.PLAYING=2;class H{constructor(e){this.maxDelta=.064,this.timer=e}update(){this.delta=this.timer.delta/1e3,this.delta>this.maxDelta&&(this.delta=this.maxDelta)}}t.ClassUtils.regClass("Spine2DRenderNode",X);class Y extends t.Sprite{constructor(){super(),this._spineComponent=this.addComponent(X)}get externalSkins(){return this._spineComponent.externalSkins}set externalSkins(e){this._spineComponent.externalSkins=e}resetExternalSkin(){this._spineComponent.resetExternalSkin()}get source(){return this._spineComponent.source}set source(e){this._spineComponent.source=e}get skinName(){return this._spineComponent.skinName}set skinName(e){this._spineComponent.skinName=e}get animationName(){return this._spineComponent.animationName}set animationName(e){this._spineComponent.animationName=e}get loop(){return this._spineComponent.loop}set loop(e){this._spineComponent.loop=e}get templet(){return this._spineComponent.templet}set templet(e){this._spineComponent.templet=e}set currentTime(e){this._spineComponent.currentTime=e}get playState(){return this._spineComponent.playState}get spineItem(){return this._spineComponent.spineItem}set spineItem(e){this._spineComponent.spineItem=e}play(e,t,n=!0,r=0,i=0,s=!0,a=!0){this._spineComponent.play(e,t,n,r,i,s,a)}getAnimNum(){return this._spineComponent.getAnimNum()}getAniNameByIndex(e){return this._spineComponent.getAniNameByIndex(e)}getSlotByName(e){return this._spineComponent.getSlotByName(e)}playbackRate(e){this._spineComponent.playbackRate(e)}showSkinByName(e){this._spineComponent.showSkinByName(e)}showSkinByIndex(e){this._spineComponent.showSkinByIndex(e)}stop(){this._spineComponent.stop()}paused(){this._spineComponent.paused()}resume(){this._spineComponent.resume()}destroy(e=!0){this._spineComponent.templet&&this._spineComponent.clear(),super.destroy(e)}addAnimation(e,t=!1,n=0){this._spineComponent.addAnimation(e,t,n)}setMix(e,t,n){this._spineComponent.setMix(e,t,n)}getBoneByName(e){return this._spineComponent.getBoneByName(e)}getSkeleton(){return this._spineComponent.getSkeleton()}setSlotAttachment(e,t){this._spineComponent.setSlotAttachment(e,t)}}e.ESpineRenderType=void 0,(B=e.ESpineRenderType||(e.ESpineRenderType={}))[B.boneGPU=0]="boneGPU",B[B.normal=1]="normal",B[B.rigidBody=2]="rigidBody";const K=!1,J=!0;t.Loader.registerLoader(["skel"],class{load(e){let n=t.Utils.replaceFileExtension(e.url,"atlas");return Promise.all([e.loader.fetch(e.url,"skel"==e.ext?"arraybuffer":"json",e.progress.createCallback()),e.loader.fetch(n,"text",e.progress.createCallback())]).then(t=>{if(!t[0]||!t[1])return null;let n=new O,r=O.RuntimeVersion.split("."),i=Math.floor(Number(r[0])),s=Math.floor(Number(r[1]));return i>=4&&s>=1&&(n.needSlot=!0),i>=4?this.parseAtlas4(t[0],t[1],e,n):this.parseAtlas3(t[0],t[1],e,n)})}parseAtlas3(e,n,r,i){var s;let a=[],o=t.URL.getPath(r.url),h=new spine.TextureAtlas(n,e=>{let n=o+e;return a.push({url:n,type:t.Loader.TEXTURE2D,propertyParams:{premultiplyAlpha:K},constructParams:[0,0,t.TextureFormat.R8G8B8A8,!1,!1,J,K]}),new L(null)});return t.Laya.loader.load(a,null,null===(s=r.progress)||void 0===s?void 0:s.createCallback()).then(t=>{let n={},r=!0;for(var s=0;s<t.length;s++){let e=t[s];e&&e._addReference();let i=h.pages[s];r=i.pma||e&&e._premultiplyAlpha&&r,i.texture.realTexture=e,i.texture.setFilters(i.minFilter,i.magFilter),i.texture.setWraps(i.uWrap,i.vWrap),i.width=i.texture.getImage().width,i.height=i.texture.getImage().height,n[i.name]=e}let a=h.regions;for(const e of a){let t=e.page;e.u=e.x/t.width,e.v=e.y/t.height,e.rotate?(e.u2=(e.x+e.height)/t.width,e.v2=(e.y+e.width)/t.height):(e.u2=(e.x+e.width)/t.width,e.v2=(e.y+e.height)/t.height)}return i._parse(e,h,n,r),i})}parseAtlas4(e,n,r,i){var s;let a=new spine.TextureAtlas(n),o=t.URL.getPath(r.url);return t.Laya.loader.load(a.pages.map(e=>({url:o+e.name,type:t.Loader.TEXTURE2D,propertyParams:{premultiplyAlpha:K},constructParams:[0,0,t.TextureFormat.R8G8B8A8,!1,!1,J,K]})),null,null===(s=r.progress)||void 0===s?void 0:s.createCallback()).then(t=>{let n={},r=a.pages,s=!0;for(let e=0,i=t.length;e<i;e++){let i=t[e];i&&i._addReference();let a=r[e];s=a.pma||i._premultiplyAlpha&&s,n[a.name]=i,a.setTexture(new L(i))}return i._parse(e,a,n,s),i})}},t.Loader.SPINE);let Z=t.ClassUtils.regClass;Z("SpineSkeleton",Y),Z("ExternalSkin",n),Z("ExternalSkinItem",r),t.Laya.addBeforeInitCallback(()=>{t.PlayerConfig.spineVersion&&(O.RuntimeVersion=t.PlayerConfig.spineVersion)});class q extends t.Script{constructor(){super()}onEnable(){this.bakeData&&this.initBake(JSON.parse(this.bakeData))}onDisable(){let e=this.owner.getComponent(X);e.spineItem&&e.spineItem.initBake(null)}async attach(e){let n=await t.Laya.loader.load({url:this.url,type:t.Loader.TEXTURE2D,constructParams:[256,256,t.TextureFormat.R32G32B32A32,!1,!1,!1,!1]});e.initBake({bonesNums:60,aniOffsetMap:{idle:0,skill:21480},texture2d:n})}async initBake(e){const n=e.aniOffsetMap.textureWidth||256;let r=await t.Laya.loader.load({url:e.simpPath,type:t.Loader.TEXTURE2D,constructParams:[n,n,t.TextureFormat.R32G32B32A32,!1,!1,!1,!1]});e.texture2d=r;let i=this.owner.getComponent(X);!i.spineItem||i.spineItem instanceof W?this.owner.on(t.Event.READY,this,()=>{i.spineItem.initBake(e)}):i.spineItem.initBake(e)}}t.ClassUtils.regClass("SpineBakeScript",q);class ${constructor(){this._recoverList=new t.FastSinglelist}check(e,t){return e.materialShaderData==t.materialShaderData&&!e.geometry.instanceCount&&!t.geometry.instanceCount}batchRenderElement(e,t,n,r=1){let i=e.elements,s=-1;for(let r=0;r<n-1;r++){let n=t+r,a=i[n],o=i[n+1];this.check(a,o)?-1==s&&(s=r):(-1!=s&&this.batch(e,s+t,r-s),s=0)}-1!=s&&this.batch(e,s+t,n-s)}updateBuffer(e,t,n,r){let i=e.nMatrixInstanceVB,s=e.simpleAnimatorVB;i.setData(t.buffer,0,0,6*r*4),s.setData(n.buffer,0,0,4*r*4)}batch(e,n,r){let i,a,o,h=e.elements,l=Q._instanceBufferCreate(6*Q.MaxInstanceCount),d=Q._instanceBufferCreate(4*Q.MaxInstanceCount),u=0;for(let p=0;p<r;p++){let r=h[n+p],m=r.value2DShaderData;if(!i){let e=r.geometry;o=Q.getInstanceInfo(e),i=o.element,this._recoverList.add(o),a=i.geometry,u=a.instanceCount=0,i.subShader=r.subShader,i.materialShaderData=r.materialShaderData,i.value2DShaderData=r.value2DShaderData,i.renderStateIsBySprite=r.renderStateIsBySprite,i.nodeCommonMap=r.nodeCommonMap,i.value2DShaderData.addDefine(s.SPINE_GPU_INSTANCE)}let c=m.getVector3(t.ShaderDefines2D.UNIFORM_NMATRIX_0),f=m.getVector3(t.ShaderDefines2D.UNIFORM_NMATRIX_1),_=6*u;l[_]=c.x,l[_+1]=c.y,l[_+2]=c.z,l[_+3]=f.x,l[_+4]=f.y,l[_+5]=f.z;let g=m.getVector(s.SIMPLE_SIMPLEANIMATORPARAMS),x=4*u;d[x]=g.x,d[x+1]=g.y,d[x+2]=g.z,d[x+3]=g.w,u++,a.instanceCount=u,a.instanceCount==Q.MaxInstanceCount&&(this.updateBuffer(o,l,d,a.instanceCount),e.add(i),i=null)}i&&(this.updateBuffer(o,l,d,a.instanceCount),e.add(i)),Q._instanceBufferRecover(l),Q._instanceBufferRecover(d)}recover(){let e=this._recoverList.length,t=this._recoverList.elements;for(let n=0;n<e;n++){let e=t[n];Q.recover(e)}this._recoverList.length=0}}t.Laya.addAfterInitCallback(function(){$.instance=new $});class Q{static getInstanceInfo(e){let t=Q._instanceBufferInfoMap.get(e);return t||(t=[],Q._instanceBufferInfoMap.set(e,t)),t.pop()||Q.createInstanceInfo(e)}static createInstanceInfo(e){let n=t.LayaGL.render2DRenderPassFactory.createRenderElement2D(),r=n.geometry=t.LayaGL.renderDeviceFactory.createRenderGeometryElement(t.MeshTopology.Triangles,t.DrawType.DrawElementInstance),i=t.LayaGL.renderDeviceFactory.createBufferState(),a={state:i,element:n,source:e},o=e.bufferState._vertexBuffers.slice(),h=t.LayaGL.renderDeviceFactory.createVertexBuffer(t.BufferUsage.Dynamic);h.setDataLength(16*Q.MaxInstanceCount*4),h.vertexDeclaration=s.instanceNMatrixDeclaration,h.instanceBuffer=!0,o.push(h),a.nMatrixInstanceVB=h;let l=t.LayaGL.renderDeviceFactory.createVertexBuffer(t.BufferUsage.Dynamic);return l.setDataLength(4*Q.MaxInstanceCount*4),l.vertexDeclaration=s.instanceSimpleAnimatorDeclaration,l.instanceBuffer=!0,o.push(l),a.simpleAnimatorVB=l,i.applyState(o,e.bufferState._bindedIndexBuffer),r.drawParams.elements=e.drawParams.elements.slice(),r.drawParams.length=e.drawParams.length,r.indexFormat=e.indexFormat,r.bufferState=i,a}static recover(e){let t=e.element;t.value2DShaderData.removeDefine(s.SPINE_GPU_INSTANCE),t.value2DShaderData=null,t.materialShaderData=null,t.subShader=null,t.nodeCommonMap=null,Q._instanceBufferInfoMap.get(e.source).push(e)}static _instanceBufferCreate(e){let t=Q._bufferPool[e];return t||(t=Q._bufferPool[e]=[]),t.pop()||new Float32Array(e)}static _instanceBufferRecover(e){let t=e.length,n=Q._bufferPool[t];n||(n=Q._bufferPool[t]=[]),n.push(e)}}Q.MaxInstanceCount=2048,Q._instanceBufferInfoMap=new Map,Q._bufferPool=[],e.AnimationRender=_,e.AnimationRenderProxy=v,e.AttachmentParse=S,e.ChangeDeform=u,e.ChangeDrawOrder=p,e.ChangeRGBA=m,e.ChangeSlot=c,e.ExternalSkin=n,e.ExternalSkinItem=r,e.IBCreator=D,e.MultiRenderData=A,e.SketonOptimise=k,e.SkinAniRenderData=g,e.SkinAttach=N,e.SkinRenderUpdate=P,e.SlotUtils=G,e.Spine2DRenderNode=X,e.SpineAdapter=U,e.SpineBakeScript=q,e.SpineEmptyRender=W,e.SpineInstanceBatch=$,e.SpineInstanceElement2DTool=Q,e.SpineMeshBase=a,e.SpineMeshUtils=i,e.SpineNormalRender=j,e.SpineNormalRenderBase=h,e.SpineOptimizeConst=x,e.SpineOptimizeRender=I,e.SpineShaderInit=s,e.SpineSkeleton=Y,e.SpineSkeletonRenderer=d,e.SpineTemplet=O,e.SpineTexture=L,e.SpineVirtualMesh=o,e.SpineWasmRender=F,e.SpineWasmVirturalMesh=V,e.VBBoneCreator=R,e.VBCreator=T,e.VBRigBodyCreator=M}(window.Laya=window.Laya||{},Laya);